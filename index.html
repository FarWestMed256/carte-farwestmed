<!DOCTYPE html>
<html>
<head>
  <title>Carte FarwestMed</title>
  <meta charset="utf-8" />
<meta http-equiv="Content-Security-Policy"
      content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net https://www.google.com https://www.gstatic.com https://widget.cloudinary.com https://upload-widget.cloudinary.com;
        style-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net https://widget.cloudinary.com;
        img-src 'self' data: https://cdn.jsdelivr.net https://res.cloudinary.com https://unpkg.com https://lh3.googleusercontent.com https://www.google.com https://www.gstatic.com https://a.tile.openstreetmap.org https://b.tile.openstreetmap.org https://c.tile.openstreetmap.org https://raw.githubusercontent.com;
        frame-src https://www.google.com https://www.gstatic.com https://recaptcha.google.com https://widget.cloudinary.com https://upload-widget.cloudinary.com;
        connect-src 'self'
  https://api.sheetbest.com
  https://app.nocodb.com
  https://api-adresse.data.gouv.fr
  https://res.cloudinary.com
  https://api.cloudinary.com
  https://widget.cloudinary.com
  https://upload-widget.cloudinary.com
  https://www.google.com
  https://www.gstatic.com
  https://raw.githubusercontent.com
  https://docs.google.com
  https://*.googleusercontent.com
  https://script.google.com
  https://script.googleusercontent.com;
        font-src 'self' https://cdn.jsdelivr.net;
        object-src 'none';
        base-uri 'self';
        form-action 'self';
      ">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/basiclightbox@5.0.4/dist/basicLightbox.min.css">
  <script src="https://cdn.jsdelivr.net/npm/basiclightbox@5.0.4/dist/basicLightbox.min.js"></script>
  <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
  <style>
    body { 
  margin: 0; 
  position: relative; 
}
    /* ===== Amélioration mobile : hauteur fiable + safe area ===== */
:root { --footer-h: 70px; } /* Ajuste si ton footer est plus ou moins haut */
#map { height: calc(100dvh - var(--footer-h)); } /* remplace le height: 90vh */
#footer-bar { padding-bottom: max(16px, env(safe-area-inset-bottom)); }
   #map { width: 100vw; }
    .photo-gallery img {max-width:140px;max-height:100px;margin:3px;border-radius:8px; cursor:pointer;}
    .btn-postuler {
      font-size: 1.1em;
      background: #f9d875;
      color: #4b3c10;
      border: none;
      padding: 8px 20px;
      border-radius: 10px;
      margin: 8px 0;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 6px #ddd;
      transition: background 0.15s;
      display: inline-block;
    }
    .btn-postuler:hover {
      background: #ffe49c;
}
.autocomplete-suggestion {
  padding: 10px 18px;
  cursor: pointer;
  border-bottom: 1px solid #ffecb266;
  user-select: none;
  transition: background 0.12s, color 0.12s;
  background: transparent;
}
.autocomplete-suggestion:last-child { border-bottom: none; }
.autocomplete-suggestion:hover, .autocomplete-suggestion.active {
  background: #ffe49c;
  color: #333;
}
.autocomplete-highlight {
  background: #fff3ce;
  color: #b39200;
  font-weight: bold;
  padding: 0 2px;
  border-radius: 2px;
}
    .leaflet-control-layers {
      margin-top: 90px !important;
      margin-left: 10px !important;
    }
    #sidebar-mode-emploi {
  position: fixed;
  top: 0; 
  right: 0;
  height: 100vh;
  width: 0;
  max-width: 440px;
  min-width: 0;
  background: rgba(255,251,231,0.89);
  box-shadow: -4px 0 28px #3332;
  z-index: 4000;
  overflow: hidden;
  transition: width 0.33s cubic-bezier(.83,.1,.5,1.4), min-width 0.33s;
  border-left: 2px solid #ffe49c;
  backdrop-filter: blur(2px);
}
    #sidebar-mode-emploi.open {
  box-shadow: -4px 0 28px #3332;
  /* Décale la sidebar de la largeur du bouton (48px) pour ne pas recouvrir le bouton */
  right: 0;
}
#sidebar-mode-emploi.closed {
  right: -30vw; /* ou -80vw sur mobile si tu veux la faire sortir totalement */
}

#sidebar-mode-emploi.open {
  width: 30vw;
  min-width: 340px;
  max-width: 440px;
}
@media (max-width: 900px) {
  #sidebar-mode-emploi.open {
    width: 80vw;
    min-width: 0;
    max-width: 96vw;
  }
}

.sidebar-toggle {
  position: fixed;
  top: 50%;
  left: 10px;
  transform: translateY(-50%);
  width: 48px;
  height: 64px;
  background: linear-gradient(90deg, #ffe97a 80%, #f6f0cf 100%);
  color: #9a8700;
  border: none;
  box-shadow: 1px 1px 18px #b9a22b25;
  border-radius: 0 18px 18px 0;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  z-index: 5000;
  transition: background 0.18s, color 0.18s, box-shadow 0.2s, left 0.3s;
  font-size: 2.2em;
  outline: none;
  border: 2px solid #efd600a6;
}
.sidebar-toggle:hover {
  background: linear-gradient(90deg, #fff8cf 85%, #fffbe7 100%);
  color: #b9a22b;
  box-shadow: 1px 4px 22px #ffe97a55;
}
#toggle-arrow { transition: transform 0.2s; }
@media (max-width: 900px) {
  .sidebar-toggle { width: 40px; height: 52px; font-size: 2em; }
}
#sidebar-mode-emploi.closed .sidebar-toggle {
  right: 0;
}
.sidebar-toggle:hover {
  background: #ffefbc;
  transform: translateY(-50%) scale(1.07);
  box-shadow: -2px 4px 18px #c7b24866;
}

.sidebar-content {
  padding: 24px 18px 34px 18px;   /* Mets plus de padding en bas pour éviter que le bouton cache la fin ! */
  font-size: 1.07em;
  overflow-y: auto;
  height: 100vh;                  /* Ajoute height pour assurer le scroll total */
  max-height: 100vh;
  box-sizing: border-box;
  scrollbar-width: thin;
}
#sidebar-mode-emploi.closed { width: 0; min-width: 0;}
#sidebar-mode-emploi.closed .sidebar-content { display: none;}
#toggle-arrow { transition: transform 0.2s; }
    /* Pour forcer les popups devant tout le reste */
.leaflet-popup,
.leaflet-popup-pane,
.leaflet-container .leaflet-popup,
.leaflet-container .leaflet-popup-content-wrapper,
.leaflet-container .leaflet-popup-content {
  z-index: 99999 !important;
}
   .leaflet-popup-content {
  touch-action: pan-y;
  overscroll-behavior: contain;
} 
    /* Permet un scroll interne fluide dans les popups très longs */
.leaflet-popup-content-wrapper {
  max-height: min(68vh, 520px);
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}

/* Place les contrôles et la barre de recherche en-dessous du popup */
.leaflet-top, .leaflet-bottom, .leaflet-control,
#rechercheCommune {
  z-index: 9000 !important;
  /* Tu peux aussi ajouter une transition pour l’opacité si tu veux la faire varier */
  transition: opacity 0.15s;
}
.sidebar-toggle {
  z-index: 8900 !important;
}
  /* ======= Barre de recherche sur la carte ======= */
#footer-bar {
  position: fixed;
  left: 0; right: 0; bottom: 0;
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: flex-start;  /* ou center si tu veux */
  padding: 0 0 16px 0;
  z-index: 4001;
  pointer-events: none;
  width: 100vw;
}

#recherche-bar {
  display: flex;
  align-items: center;
  position: relative;
  background: linear-gradient(90deg, #fffbe7 80%, #fffde9 100%);
  border: 2px solid #ffe97a;
  border-radius: 18px;
  box-shadow: 0 4px 18px #eec74822, 0 2px 9px #0001;
  margin-left: 16px;
  margin-right: 16px;
  pointer-events: auto;
  min-width: 280px;
}

#rechercheCommune {
  width: 260px;
  padding: 11px 18px;
  font-size: 1.11em;
  border: none;
  background: transparent;
  color: #2d2d2d;
  border-radius: 16px;
  font-style: italic;
  outline: none;
  box-shadow: none;
}

#rechercheCommune:focus {
  background: #fffde5;
}

#rechercheCommune::placeholder {
  color: #a3a29a;
  opacity: 0.93;
}

#autocomplete-list {
  position: absolute;
  left: 0;
  bottom: 100%;
  width: 100%;
  background: #fffbe7;
  color: #232323;
  border-radius: 15px 15px 0 0;
  box-shadow: 0 -6px 32px #eec74855, 0 -2px 12px #0001;
  max-height: 220px;
  overflow-y: auto;
  z-index: 9600;
  border: 1.5px solid #ffe97a;
  border-bottom: none;
  font-size: 1em;
  padding: 0;
  margin: 0;
}

.autocomplete-suggestion {
  padding: 9px 18px;
  cursor: pointer;
  border-bottom: 1px solid #ffecb266;
  user-select: none;
  transition: background 0.12s, color 0.12s;
  background: transparent;
}
.autocomplete-suggestion:last-child { border-bottom: none; }
.autocomplete-suggestion:hover, .autocomplete-suggestion.active {
  background: #ffe49c;
  color: #333;
}
.autocomplete-highlight {
  background: #fff3ce;
  color: #b39200;
  font-weight: bold;
  padding: 0 2px;
  border-radius: 2px;
}

#footer-infos {
  background: rgba(245, 245, 245, 0.95);
  color: #333;
  font-size: 1em;
  padding: 10px 24px;
  border-radius: 16px;
  box-shadow: 0 2px 18px #0002;
  font-weight: 500;
  letter-spacing: 0.04em;
  opacity: 0.98;
  margin-left: 8px;
  pointer-events: auto;
}

@media (max-width: 700px) {
  #footer-bar { flex-direction: column; align-items: stretch; padding: 0 0 7vw 0; }
  #recherche-bar { margin-left: 8vw; margin-right: 2vw; min-width: 0; }
  #rechercheCommune { width: 78vw; font-size: 0.98em; }
  #footer-infos { margin-top: 2vw; margin-left: 0; text-align: center;}
}
    .btn-partager {
  background: linear-gradient(90deg, #b6e3ff 60%, #e5f5ff 100%);
  color: #095b89;
  font-weight: bold;
  font-size: 1em;
  border: none;
  border-radius: 9px;
  padding: 8px 17px 8px 38px;
  box-shadow: 0 2px 8px #bae2ff55, 0 2px 6px #0001;
  margin-left: 14px;
  margin-top: 4px;
  transition: background 0.15s, color 0.15s, box-shadow 0.18s;
  position: relative;
  cursor: pointer;
  outline: none;
  display: inline-flex;
  align-items: center;
  gap: 0.5em;
}

.btn-partager:hover, .btn-partager:focus {
  background: linear-gradient(90deg, #e5f5ff 60%, #b6e3ff 100%);
  color: #084471;
  box-shadow: 0 4px 16px #bae2ff99, 0 2px 8px #0002;
}

/* Petite icône de partage à gauche du texte */
.btn-partager::before {
  content: '';
  display: inline-block;
  width: 21px;
  height: 21px;
  margin-right: 7px;
  background: url('https://cdn.jsdelivr.net/gh/lucide-icons/lucide/icons/share.svg') no-repeat center/85%;
  filter: brightness(0.7) saturate(2);
  position: absolute;
  left: 11px;
  top: 50%;
  transform: translateY(-50%);
  opacity: 0.85;
}
    .leaflet-popup-content button.btn-partager, 
.leaflet-popup-content .btn-partager {
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
}
  </style>
  <style>
/* Mobile only */
@media (max-width:700px){
  #mobile-publish-btn{
    position:fixed; right:16px;
    /* ← on calcule une marge au-dessus de la barre de recherche */
    bottom: calc(var(--footer-h,70px) + 72px);
    z-index:5001; pointer-events:auto;
    background:#f9d875; color:#4b3c10; border:none; border-radius:999px;
    padding:12px 18px; font-weight:700; box-shadow:0 6px 22px #0003; font-size:1.05em;
}
  #mobile-sheet-backdrop{
    position:fixed; inset:0; background:#0006; display:none; z-index:120000;
  }
  #mobile-sheet{
    position:fixed; left:0; right:0; bottom:0; max-height:88vh;
    background:#fffbe7; border-top-left-radius:16px; border-top-right-radius:16px;
    box-shadow:0 -12px 28px #0003; transform:translateY(100%); transition:transform .25s ease-out;
    z-index:120001; display:flex; flex-direction:column;
  }
  #mobile-sheet.open{ transform:translateY(0); }
  .ms-header{ padding:14px 16px; border-bottom:1px solid #ffe49c; display:flex; align-items:center; gap:8px;}
  .ms-title{ font-weight:700; font-size:1.1em;}
  .ms-body{ padding:12px 16px; overflow:auto; }
  .ms-actions{ padding:12px 16px; border-top:1px solid #ffe49c; display:flex; gap:10px; }
  .ms-actions button{ flex:1; padding:10px 14px; border-radius:10px; border:none; font-weight:700; }
  .btn-secondary{ background:#fff; border:1px solid #ffe49c; color:#574600; }
  .btn-primary{ background:#f9d875; color:#4b3c10; }
  .step{ display:none; }
  .step.active{ display:block; }
  .field{ margin-bottom:12px; }
  .field label{ display:block; font-weight:600; margin-bottom:6px; }
  .field input, .field select, .field textarea{
    width:100%; padding:10px 12px; border:1px solid #ffe49c; border-radius:10px; background:#fff;
    font-size:1em;
  }
  .inline{ display:flex; gap:10px; align-items:center; }
  .mini{ font-size:.9em; color:#666; }
  .chips{ display:flex; flex-wrap:wrap; gap:8px; }
  .chip{ padding:8px 12px; border-radius:18px; border:1px solid #ffe49c; background:#fff; cursor:pointer; }
  .chip.active{ background:#f9f2c7; border-color:#e6c74e; }
  .small-help{ font-size:.9em; color:#7a6d3b; }
}
</style>
</head>
  <!-- BARRE DE RECHERCHE EN-TÊTE -->
<body>
<div id="map"></div>
<div id="footer-bar">
  <div id="recherche-bar">
    <input
      id="rechercheCommune"
      type="text"
      autocomplete="off"
      placeholder="Rechercher une adresse"
    >
    <div id="autocomplete-list"></div>
  </div>
  <div id="footer-infos">
    Données de zonages à jour au 1er août 2025
  </div>
</div>
<!-- Ici la carte s’arrête -->
   <button class="sidebar-toggle" id="sidebar-toggle-btn" onclick="toggleSidebar()" aria-label="Afficher/masquer le mode d'emploi">
  <span id="toggle-arrow">&#9654;</span> <!-- ▶ flèche vers la droite -->
</button>
  <div id="sidebar-mode-emploi" class="sidebar closed">
  <div class="sidebar-content">
    <h3>🗺️ Mode d’emploi de la carte</h3>
    <ul style="list-style:none;padding:0;">
      <li style="margin-bottom:14px;">
  <b>🗂️ Choix des zones :</b><br>
  <span>
    Activez/désactivez les calques pour afficher :<br>
    <span style="margin-left:1em;">
      <img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png" 
           style="height:27px;vertical-align:middle;margin-right:4px;">
      <b>Communes ZIP</b> :
      Zones d’Intervention Prioritaire (prime <b>50 000 €</b> à l’installation, exonérations, aides ARS).
    </span><br>
    <span style="margin-left:1em;">
      <img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png" 
           style="height:27px;vertical-align:middle;margin-right:4px;">
      <b>Communes ZFRR</b> :
      Zones France de Ruralités Revitalisation (primes fiscales, exonérations d’impôts, aides cumulables avec ZIP).
    </span><br>
    <span style="margin-left:1em;">
      <img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png" 
           style="height:27px;vertical-align:middle;margin-right:4px;">
      <b>Communes ZAC</b> :
      Zones d’Action Complémentaire (autres dispositifs selon région).
    </span><br>
    <span style="margin-left:1em;">
  <span style="font-size:1.32em;vertical-align:middle;margin-right:4px;">⭐</span>
  <b>Communes GOLD</b> (<b>ZIP + ZFRR</b>) :
  cumulent tous les avantages !
</span>
  </span>
</li>
      <li style="margin-bottom:14px;">
        <b>📍 Parcourir la carte :</b><br>
        <span>Zoomez, cliquez sur un marqueur pour voir le détail des offres, ou explorez librement la France médicale.</span>
      </li>
      <li style="margin-bottom:14px;">
        <b>📝 Déposer une offre ou un cabinet :</b><br>
        <span>
          <span style="margin-left:1em;">• Cliquez n’importe où sur la carte pour déposer :</span><br>
          <span style="margin-left:2em;">- <b>Une offre d’emploi</b> (<span style="color:#2c91ed;">📄</span>)</span><br>
          <span style="margin-left:2em;">- <b>Un cabinet/bureau à louer</b> (<span style="color:#ffaa00;">🏢</span>)</span>
        </span>
      </li>
      <li style="margin-bottom:14px;">
        <b>💡 Répondre à une offre :</b><br>
        <span>
          <span style="margin-left:1em;">• Cliquez sur une annonce pour postuler ou signaler votre intérêt en un clic.</span>
        </span>
      </li>
      <li>
        <span style="color:#888;font-size:0.98em;">
          📣 <b>Contactez-nous :</b><br>
          <span style="color:#333;">farwestmed013@gmail.com</span>
        </span>
      </li>
    </ul>
  </div>
</div>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script>console.log('[A] Début bloc 1');</script>
  <script>
  // Logs d’erreurs JS et promesses non gérées
  window.addEventListener('error', (e) => {
    console.error('💥 JS error:', e.message, 'at', e.filename+':'+e.lineno+':'+e.colno, e.error);
  });
  window.addEventListener('unhandledrejection', (e) => {
    console.error('💥 Unhandled promise rejection:', e.reason);
  });
</script>
  <script>
    function canSubmit(formKey, limit = 5, delayMin = 60) {
  const now = Date.now();
  let logs = [];
  try {
    logs = JSON.parse(localStorage.getItem(formKey) || "[]");
  } catch (e) { logs = []; }
  // Garde seulement les entrées des X dernières minutes
  const recent = logs.filter(t => now - t < delayMin * 60 * 1000);
  if (recent.length >= limit) return false;
  recent.push(now);
  localStorage.setItem(formKey, JSON.stringify(recent));
  return true;
}
 function showCarteNotification(msg, timeout = 2500) {
  const notif = document.createElement('div');
  notif.textContent = msg;
  notif.style.cssText = `
    position: fixed;
    top: 40px; left: 50%;
    transform: translateX(-50%);
    background: #222;
    color: #fff;
    font-size: 1.15em;
    padding: 13px 30px;
    border-radius: 12px;
    box-shadow: 0 8px 22px #0002;
    z-index: 4000;
    opacity: 0.98;
    pointer-events: none;
    transition: opacity 0.2s;
  `;
  document.body.appendChild(notif);
  setTimeout(() => { notif.style.opacity = '0'; }, timeout - 350);
  setTimeout(() => { notif.remove(); }, timeout);
}
    function cleanNom(str) {
  return str
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .toLowerCase()
    .replace(/[\s'-]/g,"");
}
    function forceLineBreaksAfterDot(str) {
  if (!str) return '';
  // Ajoute <br> après chaque point suivi d'un espace (optionnel), SAUF si :
  // - précédé d'un chiffre (numéro)
  // - précédé d'un @ (mail)
  // - suivi de com/fr/org/net/gov/edu (mail/url)
  return str.replace(/([^0-9@])\. ?(?!((com|fr|org|net|gov|edu)\b))/gi, '$1.<br>');
}
    function addLineBreaksBeforeEmoji(str) {
  if (!str) return '';
  return str.replace(
    /([^\n])([\u{1F300}-\u{1FAFF}\u{1F1E6}-\u{1F1FF}\u2600-\u27BF\u{1F900}-\u{1F9FF}\u231A-\u231B\u23E9-\u23EC\u23F0-\u23F4\u25FD-\u25FE\u2614-\u2615\u2648-\u2653\u267F\u2693\u26A1\u26AA-\u26AB\u26BD-\u26BE\u26C4-\u26C5\u26CE\u26D4\u26EA\u26F2-\u26FA\u26FD\u2705\u270A-\u270B\u2728\u274C\u274E\u2753-\u2755\u2757\u2795-\u2797\u27B0\u27BF\u2934-\u2935\u2B05-\u2B07\u2B1B-\u2B1C\u2B50\u2B55\u3030\u303D\u3297\u3299])/gu,
    function(match, prev, emoji) {
      if (prev === '\n' || prev === '<br>') return prev + emoji;
      return prev + '<br>' + emoji;
    }
  );
}
    function nl2br(str) {
  if (!str) return '';
  return str.replace(/(?:\r\n|\r|\n)/g, '<br>');
}
    // Mapping type d'offre → URL d’icône
const iconesTypeOffre = {
  "Médecin généraliste": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/doctor.svg",
  "Médecin spécialiste": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/doctor.svg",
  "Kinésithérapeute": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/physiotherapist.svg",
  "Sage-femme": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/midwife.svg",
  "Infirmier(e) diplômé(e) d’État (IDE)": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/nurse.svg",
  "Infirmier(e) Asalée": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/nurse.svg",
  "Orthophoniste": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/speech-therapist.svg",
  "Orthoptiste": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/optometrist.svg",
  "Psychologue": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/psychologist.svg",
  "Ergothérapeute": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/physiotherapist.svg",
  "Pédicure-podologue": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/foot-doctor.svg",
  "Diététicien(ne)": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/dietitian.svg",
  "Psychomotricien(ne)": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/psychologist.svg",
  "Ostéopathe": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/physiotherapist.svg",
  "Chirurgien-dentiste": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/dentist.svg",
  "Ophtalmologiste": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/ophthalmologist.svg",
  "Pharmacien(ne)": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/pharmacist.svg",
  "Secrétaire médical(e)": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/receptionist.svg",
  "Assistant(e) médical(e)": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/medical-assistant.svg",
  "Aide-soignant(e)": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/nurse.svg",
  "Autre professionnel de santé": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/doctor.svg"
};
    // URLs d'API Sheet.best pour chaque sheet
   const API_OFFRES = "https://script.google.com/macros/s/AKfycbxGmcxQ-fI8DSOOXQkiaO53bN3WAWLET810l2OchszzFNuCAL2vI631M86ENE2Qvjyz/exec";
    const API_CANDIDATURES = "https://api.sheetbest.com/sheets/fea9ad93-6045-46ef-af9d-9ed93a9f5a4c";
    // LECTURE (GET) des offres via CSV public Google Sheets
const CSV_OFFRES_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSuVlH3Pg3XsXBZf9LKYAI-vrGL5Mln9HsAnHyQ1tomqhXeTIF825awcH1ohzxcFl_DtCDyLwTluEqz/pub?gid=0&single=true&output=csv";
    function toNumber(v){
  if (v == null) return null;
  const n = Number(String(v).trim().replace(',', '.'));
  return Number.isFinite(n) ? n : null;
}
function isPubliee(s){
  return String(s || "")
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .trim().toLowerCase() === "publiee";
}
function normalizeOffre(row){
  // Harmonise les colonnes issues du CSV
  const lat = toNumber(row["Latitude"] ?? row["lat"]);
  const lng = toNumber(row["Longitude"] ?? row["lng"]);
  return {
    ...row,
    Latitude: lat,
    Longitude: lng,
    Statut: (row["Statut"] ?? "").toString().trim(),
    TitreOffre: row["Titre de l’offre"] ?? row["Titre de l'offre"] ?? row["Titre"] ?? "",
    NomStruct: row["Nom de la struct"] ?? row["Nom de la structure"] ?? "",
    Adresse: row["Adresse"] ?? "",
    Description: row["Description"] ?? "",
    Email: row["Adresse Email"] ?? row["Email"] ?? "",
    Contact: row["Contact"] ?? "",
    Photos: row["Photos"] ?? ""
  };
}
const API_LOCATIONS = "https://app.nocodb.com/api/v2/tables/ml3ezzqhxcfuhpi/records";
const API_TOKEN = "zuBtJi0p7vALQo2W_HTWzvaYRxyyQKOhRaLsrNU4";
    // === CANDIDATURES (NocoDB) ===
const API_CANDIDATS = "https://app.nocodb.com/api/v2/tables/mhe5xzp4dsum4x1/records"; // ton endpoint

// Pin violet "CV"
const candidateSvg = `
<svg xmlns='http://www.w3.org/2000/svg' width='40' height='54' viewBox='0 0 40 54'>
 <defs><filter id='s' x='-50%' y='-50%' width='200%' height='200%'><feDropShadow dx='0' dy='1' stdDeviation='1.2' flood-opacity='.25'/></filter></defs>
 <g filter='url(#s)'>
  <path d='M20 0c10.5 0 19 8.5 19 19 0 5.2-2 9.9-5.3 13.3L20 54 6.3 32.3A18.9 18.9 0 0 1 1 19C1 8.5 9.5 0 20 0z' fill='#7c3aed'/>
  <circle cx='20' cy='16' r='7' fill='#fff'/>
  <rect x='10' y='27' width='20' height='9' rx='4.5' fill='#fff'/>
  <text x='20' y='34' text-anchor='middle' font-size='7' font-family='Arial,Helvetica,sans-serif' fill='#7c3aed' font-weight='700'>CV</text>
 </g>
</svg>`;
const candidateIcon = L.icon({
  iconUrl: 'data:image/svg+xml;utf8,' + encodeURIComponent(candidateSvg),
  iconSize: [40,54], iconAnchor: [20,54], popupAnchor: [0,-50]
});
function chargerCandidats() {
  fetch(API_CANDIDATS + "?limit=1000", { headers: { "xc-token": API_TOKEN }})
    .then(r => r.json())
    .then(data => {
      (data.list || data).forEach(c => {
        if (!c.Latitude || !c.Longitude) return;

        const emploi = c["Emploi recherché"] || "";
        const dispo  = c["Disponibilité"]   || "";
        const tel    = c["Téléphone"]       || "";

        L.marker([parseFloat(c.Latitude), parseFloat(c.Longitude)], {icon: candidateIcon})
          .addTo(candidatsLayer)
          .bindPopup(
            `<b>Candidature – ${emploi || 'Profession'}</b><br>
             ${c.Nom || ''}<br>
             ${c.Title ? `Titre : ${c.Title}<br>` : ''}
             ${c.Zone ? `Zone souhaitée : ${c.Zone}<br>` : ''}
             ${dispo ? `Dispo : ${dispo}<br>` : ''}
             ${addLineBreaksBeforeEmoji(forceLineBreaksAfterDot(nl2br(c.Description || '')))}<br>
             <b>Contact :</b> ${c.Email || ''}${tel ? ' · ' + tel : ''}`
          );
      });
    });
}
    function showLightbox(url) {
      basicLightbox.create('<img src="' + url + '" style="max-width:90vw;max-height:90vh;">').show();
    }
    window.showLightbox = showLightbox;

    function normaliserTypeOffre(type) {
  let t = (type || "").trim();
  if (t === "Aide-soignant(e)") return "Autre professionnel de santé";
  if (t === "Autre professionnel de santé") return "Offre d'emploi pluridisciplinaire";
  return t;
}
    function chargerOffres() {
  const url = CSV_OFFRES_URL + "&t=" + Date.now(); // anti-cache
  fetch(url, { cache: "no-store" })
    .then(resp => {
      if (!resp.ok) throw new Error("CSV fetch failed: " + resp.status);
      return resp.text();
    })
    .then(csvText => {
      const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
      if (parsed.errors?.length) console.warn("CSV parse warnings:", parsed.errors.slice(0,3));
      const rows = parsed.data.map(normalizeOffre);

      console.log("Total lignes CSV:", rows.length);
      let shown = 0;

      rows.forEach(function(offre, idx) {
        // Filtre : n’affiche que les offres publiées
        if (!isPubliee(offre.Statut)) return;

        if (!Number.isFinite(offre.Latitude) || !Number.isFinite(offre.Longitude)) {
          console.warn("Coordonnées manquantes, skip:", offre.TitreOffre || offre.NomStruct || offre.Adresse);
          return;
        }

        // Galerie photos
        let gallery = "";
        if (offre.Photos) {
          let urls = String(offre.Photos).split(",");
          gallery = '<div class="photo-gallery">' +
            urls.map(u => u.trim() ? '<img src="'+u.trim()+'" alt="photo" onclick="window.showLightbox(\''+u.trim()+'\')">' : "").join("") +
            '</div>';
        }

        // Emoji par type
        const emojisTypeOffre = {
          "Médecin généraliste": "🩺","Médecin spécialiste": "🩻","Kinésithérapeute": "💪","Sage-femme": "🤱",
          "Infirmier(e) diplômé(e) d’État (IDE)": "💉","Infirmier(e) Asalée": "💉","Orthophoniste": "🗣️","Orthoptiste": "👁️",
          "Psychologue": "🧠","Ergothérapeute": "🖐️","Pédicure-podologue": "🦶","Diététicien(ne)": "🥗","Psychomotricien(ne)": "🤸",
          "Ostéopathe": "👐","Chirurgien-dentiste": "🦷","Ophtalmologiste": "👓","Pharmacien(ne)": "💊",
          "Secrétaire médical(e)": "🗂️","Assistant(e) médical(e)": "👩‍💼","Autre professionnel de santé": "⚕️",
          "Offre d'emploi pluridisciplinaire": "👩🏻‍⚕️"
        };
        var typeOffre = normaliserTypeOffre(offre.TitreOffre);
        var emoji = emojisTypeOffre[typeOffre] || "❓";

        // Contenu du popup
        var postulerId = `btn-postuler-${idx}`;
        var popupHtml =
          `<b>${typeOffre || ''}</b><br>
           ${offre.NomStruct || ''}<br>
           ${offre.Adresse || ''}<br>
           ${addLineBreaksBeforeEmoji(forceLineBreaksAfterDot(nl2br(offre.Description || '')))}<br>
           ${gallery}
           <b>Contact :</b> ${offre.Contact || ''}<br>
           ${offre.Email ? `<b>Email :</b> ${offre.Email}<br>` : ""}
           <button type="button" class="btn-postuler" id="${postulerId}"
             data-email="${offre.Email || ''}" 
             data-contact="${offre.Contact || ''}">Postuler à cette offre</button>
           <button type="button" class="btn-partager"
             data-lat="${offre.Latitude}" data-lng="${offre.Longitude}" data-type="offre"
             style="margin-left:10px;">Partager</button>
           <span class="popup-share-menu" style="display:none;position:relative;z-index:9999;"></span>`;

        // Icône personnalisée
        var customIcon = L.divIcon({
          html: `<div style="
            font-size:2.2em;width:46px;height:46px;border-radius:50%;
            background:#fff;border:2px solid #eee;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 5px #0002;
          ">${emoji}</div>`,
          className: '', iconSize: [46,46], iconAnchor: [23,46], popupAnchor: [0,-46]
        });

        var marker = L.marker([offre.Latitude, offre.Longitude], {icon: customIcon})
          .addTo(map)
          .bindPopup(popupHtml);

  

        shown++;
      });

      console.log("Marqueurs affichés:", shown);
      if (shown === 0) {
        console.warn("Aucun marqueur affiché. Vérifie les noms de colonnes Latitude/Longitude ou leur format.");
      }
    })
    .catch(err => {
      console.error("Chargement Google Sheets échoué:", err);
      alert("Impossible de charger les offres pour le moment.");
    });
}

    var map = L.map('map').setView([46.7, 2.5], 6);
window.map = map; // permet d'y accéder depuis d'autres fonctions
    window.markersByName = {};

window.addEventListener('resize', () => map.invalidateSize());
window.addEventListener('orientationchange', () => {
  setTimeout(() => map.invalidateSize(), 250);
});
    // Mobile-specific popup defaults
if (window.matchMedia('(max-width: 700px)').matches) {
  const footerH = parseInt(getComputedStyle(document.documentElement)
                    .getPropertyValue('--footer-h')) || 70;

  L.Popup.prototype.options.maxWidth = Math.min(window.innerWidth * 0.92, 480);
  L.Popup.prototype.options.autoPan = true;          // centre à l’ouverture
  L.Popup.prototype.options.keepInView = false;      // ⬅️ permet de panner librement ensuite
  L.Popup.prototype.options.autoPanPaddingTopLeft = [10, 80];
  L.Popup.prototype.options.autoPanPaddingBottomRight = [10, footerH + 24];
}
    var candidatsLayer = L.layerGroup().addTo(map);
window.onload = function() {
  document.getElementById('rechercheCommune').addEventListener('mousedown', function(e) {
    e.stopPropagation();
  });
  document.getElementById('autocomplete-list').addEventListener('mousedown', function(e) {
    e.stopPropagation();
  });
};
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '© OpenStreetMap contributors'
}).addTo(map);
    map.on('popupopen', (e) => {
  const el = e?.popup?.getElement()?.querySelector('.leaflet-popup-content');
  if (el) el.scrollTop = 0;
});

map.whenReady(function() {
  const urlParams = new URLSearchParams(window.location.search);
  const lat = parseFloat(urlParams.get('lat'));
  const lng = parseFloat(urlParams.get('lng'));
  const zoom = parseInt(urlParams.get('zoom')) || 15;

  if (!isNaN(lat) && !isNaN(lng)) {
    setTimeout(function() {
      map.setView([lat, lng], zoom, { animate: true });

      // Essaie de trouver un marker à proximité et ouvrir le popup (offre ou location)
      let found = false;
      map.eachLayer(function(layer) {
        if (layer.getLatLng && layer.openPopup) {
          const markerLatLng = layer.getLatLng();
          const dist = map.distance(markerLatLng, L.latLng(lat, lng));
          if (dist < 70 && !found) { // 70m de tolérance, tu peux adapter
            found = true;
            layer.openPopup();
          }
        }
      });
    }, 700);
  }
});
// Décalage du centre vers la gauche (pour sidebar à droite)
map.whenReady(function() {
  const urlParams = new URLSearchParams(window.location.search);
  const lat = parseFloat(urlParams.get('lat'));
  const lng = parseFloat(urlParams.get('lng'));

  // Si pas de coordonnées dans l'URL et sidebar ouverte -> décaler
  if (isNaN(lat) || isNaN(lng)) {
    setTimeout(function() {
      const sb = document.getElementById('sidebar-mode-emploi');
      if (sb && sb.classList.contains('open')) {
        const size = map.getSize();
        map.panBy([size.x * 0.18, 0], { animate: false });
      }
    }, 400);
  }
});
    chargerOffres();
    chargerLocationsExistantes();
    chargerCandidats();
function chargerLocationsExistantes() {
  fetch(API_LOCATIONS, {
    method: "GET",
    headers: { "xc-token": API_TOKEN }
  })
  .then(resp => resp.json())
  .then(data => {
    (data.list || data).forEach(function(loc) {
      if (loc.Statut && loc.Statut.toLowerCase() === "archivée") return;
      if (!loc.Latitude || !loc.Longitude) return;
      let gallery = "";
      if (loc.Photos) {
        let urls = loc.Photos.split(",");
        gallery = '<div class="photo-gallery">' +
          urls.map(u => u.trim() ? '<img src="'+u.trim()+'" alt="photo" onclick="window.showLightbox(\''+u.trim()+'\')">' : "").join("") +
          '</div>';
      }
      var locationIcon = L.divIcon({
        html: `<div style="
          font-size:2em;
          width:40px;height:40px;
          border-radius:50%;
          background:#fffbe7;
          border:2px solid #ffe49c;
          display:flex;
          align-items:center;
          justify-content:center;
          box-shadow:0 1px 5px #ffd70077;
        ">🏢</div>`,
        className: '',
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40]
      });
      L.marker([parseFloat(loc.Latitude), parseFloat(loc.Longitude)], {icon: locationIcon})
        .addTo(map)
        .bindPopup(
          `<b>Cabinet ou bureau à louer</b><br>
          ${loc.Adresse || ""}<br>
          ${addLineBreaksBeforeEmoji(forceLineBreaksAfterDot(nl2br(loc.Description || '')))}<br>
          ${gallery}
          <b>Contact :</b> ${loc.Contact || ""}<br>
          ${loc.Email ? `<b>Email :</b> ${loc.Email}<br>` : ""}
          <button type="button" class="btn-interesse-location"
            data-email="${loc.Email || ""}"
            data-contact="${loc.Contact || ""}"
            data-adresse="${loc.Adresse || ""}"
            data-description="${loc.Description || ""}"
            style="background:#B6E3FF;color:#095b89;padding:6px 18px;font-size:1em;border-radius:8px;border:none;cursor:pointer;margin-top:8px;margin-bottom:4px;">
            Ça m'intéresse&nbsp;!
          </button>
          <button type="button" class="btn-partager"
            data-lat="${loc.Latitude}" data-lng="${loc.Longitude}" data-type="location"
            style="margin-left:10px;">Partager</button>
          <span class="popup-share-menu" style="display:none;position:relative;z-index:9999;"></span>`
        );
    });
  });
}
// 1. Crée le layer ZIP
var zipCluster = L.markerClusterGroup().addTo(map);
    var zrrCluster = L.markerClusterGroup().addTo(map);
    var goldCluster = L.markerClusterGroup().addTo(map);
    var zacCluster = L.markerClusterGroup().addTo(map);
// 2. Fonction d'import du CSV ZIP
function importerZIP(csvFile, groupLayer) {
  console.log('importerZIP appelée !');
  fetch(csvFile)
    .then(resp => resp.text())
    .then(csvText => {
      Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          console.log('PapaParse terminé, nb lignes :', results.data.length, results.data[0]);
          results.data.forEach(function(row) {
            var lat = parseFloat(row.Latitude || row.latitude || row.lat);
            var lon = parseFloat(row.Longitude || row.longitude || row.lon);
var nom = row["Nom de la commune"] || row["Commune"] || row["commune"] || row["Nom Commune"] || row["Ville"] || row["Nom"] || row.nom || "Ville ZIP";            if (!isNaN(lat) && !isNaN(lon)) {
  var redIcon = L.icon({
                iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
                shadowSize: [41, 41]
              });
              // Ajoute le marqueur ZIP + infobulle au survol
              let marker = L.marker([lat, lon], {icon: redIcon, title: nom})
  .bindTooltip(nom, {permanent: false, direction: "top"});
groupLayer.addLayer(marker); 
              // Ajoute cette ligne juste après avoir créé le marker :
if (!window.markersByName) window.markersByName = {};
window.markersByName[cleanNom(nom)] = marker;
            }
          });
        }
      });
    });
}
    // 3. Importe le calque ZIP (mets le nom réel de ton fichier CSV !)
importerZIP('communes_zip_geo.csv', zipCluster);
    function importerZRR(csvFile, groupLayer) {
  fetch(csvFile)
    .then(resp => resp.text())
    .then(csvText => {
      Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          results.data.forEach(function(row) {
            var lat = parseFloat(row.Latitude || row.latitude || row.lat);
            var lon = parseFloat(row.Longitude || row.longitude || row.lon);
            var nom = row["Commune"] || row["commune"] || row["Nom Commune"] || row["Ville"] || row["Nom"] || row.nom || "Ville ZRR";            
            if (!isNaN(lat) && !isNaN(lon)) {
              var greenIcon = L.icon({
                iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
                shadowSize: [41, 41]
              });
              let marker = L.marker([lat, lon], {icon: greenIcon, title: nom})
                .bindTooltip(nom, {permanent: false, direction: "top"});
              groupLayer.addLayer(marker);

              // On peut aussi les référencer dans un autre objet si besoin
              if (!window.zrrMarkersByName) window.zrrMarkersByName = {};
              window.zrrMarkersByName[cleanNom(nom)] = marker;
            }
          });
        }
      });
    });
}
importerZRR('communes_zrr_geo.csv', zrrCluster);

    function importerGOLD(csvFile, groupLayer) {
  fetch(csvFile)
    .then(resp => resp.text())
    .then(csvText => {
      Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          results.data.forEach(function(row) {
            var lat = parseFloat(row.Latitude || row.latitude || row.lat);
            var lon = parseFloat(row.Longitude || row.longitude || row.lon);
            var nom = row["Commune"] || row["Nom de la commune"] || row["commune"] || row.nom || "Commune GOLD";
            if (!isNaN(lat) && !isNaN(lon)) {
              var goldIcon = L.divIcon({
  className: 'gold-div-icon',
  iconSize: [38, 54],
  iconAnchor: [19, 54],
  popupAnchor: [1, -34],
  html: `
    <div style="
      position: relative;
      width: 38px;
      height: 54px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    ">
      <span style="
        font-size: 1.7em;
        color: #ffe066;
        text-shadow: 0 0 10px #ffd700, 0 0 3px #fff;
        position: absolute;
        top: 2px;
        left: 8px;
        z-index: 2;
      ">⭐</span>
      <img src="https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-yellow.png"
        style="
          width: 38px;
          height: 54px;
          filter:
            drop-shadow(0 0 8px #ffd700)
            brightness(1.4)
            saturate(1.5);
        "
      />
    </div>
  `
});
              let marker = L.marker([lat, lon], {icon: goldIcon, title: nom})
                .bindTooltip(nom, {permanent: false, direction: "top"});
              groupLayer.addLayer(marker);
              if (!window.goldMarkersByName) window.goldMarkersByName = {};
              window.goldMarkersByName[cleanNom(nom)] = marker;
            }
          });
        }
      });
    });
}

importerGOLD('https://raw.githubusercontent.com/FarWestMed256/carte-farwestmed/refs/heads/main/communes_gold_geo.csv', goldCluster);
    
   function importerZAC(csvFile, groupLayer) {
     console.log("Appel importerZAC avec le fichier :", csvFile);
  fetch(csvFile)
    .then(resp => resp.text())
    .then(csvText => {
      Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          results.data.forEach(function(row) {
            var lat = parseFloat(row.Latitude);
            var lon = parseFloat(row.Longitude);
            var nom = row.Commune || "Commune ZAC";
            if (!isNaN(lat) && !isNaN(lon)) {
              var blueIcon = L.icon({
                iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
                shadowSize: [41, 41]
              });
              let marker = L.marker([lat, lon], {icon: blueIcon, title: nom})
                .bindTooltip(nom, {permanent: false, direction: "top"});
              groupLayer.addLayer(marker);
              if (!window.zacMarkersByName) window.zacMarkersByName = {};
              window.zacMarkersByName[cleanNom(nom)] = marker;
            }
          });
        }
      });
    });
}

    importerZAC('communes_zac_geoloc.csv', zacCluster);
// Fonction utilitaire pour remplir le datalist
// ------------------- AUTOCOMPLETE CUSTOM ZIP + ADRESSE -------------------
let autocompleteIndex = -1; // pour le survol clavier

document.getElementById('rechercheCommune').addEventListener('input', function(e) {
  const val = cleanNom(this.value.trim());
  const raw = this.value.trim();
  const box = document.getElementById('autocomplete-list');
  let suggestions = [];

  // 1. Ajoute les communes ZIP (ZIP FarWestMed)
  if (window.markersByName) {
    Object.keys(window.markersByName).forEach(function(key) {
      let marker = window.markersByName[key];
      if (marker && marker.options && marker.options.title) {
        if (cleanNom(marker.options.title).indexOf(val) !== -1 || key.indexOf(val) !== -1) {
          suggestions.push(marker.options.title);
        }
      }
    });
  }

  // 2. Ajoute les suggestions adresses API data.gouv
  let apiDone = false;
  const fill = (finalSuggestions) => {
    // Surlignage
    let regex = new RegExp('('+raw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')+')', 'ig');
    box.innerHTML = finalSuggestions.slice(0, 20).map((s, i) => 
      `<div class="autocomplete-suggestion${i===0 ? ' active':''}" tabindex="-1" data-label="${s.replace(/"/g,'&quot;')}">
        ${s.replace(regex, '<span class="autocomplete-highlight">$1</span>')}
      </div>`
    ).join('');
    autocompleteIndex = 0;
  };

  if (raw.length > 2) {
    fetch('https://api-adresse.data.gouv.fr/search/?q=' + encodeURIComponent(raw) + '&limit=20')
      .then(r => r.json())
      .then(json => {
        if (json.features && json.features.length > 0) {
          json.features.forEach(f => {
            if (suggestions.indexOf(f.properties.label) === -1) {
              suggestions.push(f.properties.label);
            }
          });
        }
        fill(suggestions);
      });
  } else {
    fill(suggestions);
  }
});

// 3️⃣ Sélection à la souris
document.getElementById('autocomplete-list').addEventListener('mousedown', function(e) {
  if (e.target.classList.contains('autocomplete-suggestion')) {
    document.getElementById('rechercheCommune').value = e.target.dataset.label;
    triggerRechercheCommune(e.target.dataset.label);
    this.innerHTML = "";
  }
});

// 4️⃣ Navigation clavier (flèches + entrée)
document.getElementById('rechercheCommune').addEventListener('keydown', function(e) {
  const box = document.getElementById('autocomplete-list');
  let items = Array.from(box.children);
  if (!items.length) return;

  if (e.key === 'ArrowDown') {
    autocompleteIndex = (autocompleteIndex + 1) % items.length;
    items.forEach(el => el.classList.remove('active'));
    items[autocompleteIndex].classList.add('active');
    items[autocompleteIndex].scrollIntoView({block:'nearest'});
    e.preventDefault();
  }
  if (e.key === 'ArrowUp') {
    autocompleteIndex = (autocompleteIndex - 1 + items.length) % items.length;
    items.forEach(el => el.classList.remove('active'));
    items[autocompleteIndex].classList.add('active');
    items[autocompleteIndex].scrollIntoView({block:'nearest'});
    e.preventDefault();
  }
  if (e.key === 'Enter') {
    if (items[autocompleteIndex]) {
      this.value = items[autocompleteIndex].dataset.label;
      triggerRechercheCommune(items[autocompleteIndex].dataset.label);
      box.innerHTML = "";
      e.preventDefault();
    }
  }
  if (e.key === 'Escape') {
    box.innerHTML = "";
  }
});

// 5️⃣ Sélection logique (ce qui se passe quand on choisit une suggestion)
function triggerRechercheCommune(val) {
  var recherche = val.trim();
  var key = cleanNom(recherche);
  // Recherche ZIP
  var trouve = null;
  Object.keys(window.markersByName).forEach(function(k) {
    var marker = window.markersByName[k];
    if (marker && marker.options && cleanNom(marker.options.title || k) === key) {
      trouve = marker;
    }
  });
  if (trouve) {
    map.setView(trouve.getLatLng(), 13);
    trouve.openPopup();
    return;
  }
  // Sinon API adresse
  fetch('https://api-adresse.data.gouv.fr/search/?q=' + encodeURIComponent(recherche) + '&limit=1')
    .then(r => r.json())
    .then(json => {
      if (json.features && json.features.length > 0) {
        var coords = json.features[0].geometry.coordinates;
        var label = json.features[0].properties.label;
        map.setView([coords[1], coords[0]], 16);
        if (window.chercheMarker) map.removeLayer(window.chercheMarker);
        window.chercheMarker = L.marker([coords[1], coords[0]]).addTo(map).bindPopup(label).openPopup();
      } else {
        alert("Adresse ou commune non trouvée.");
      }
    });
}

// Fermer suggestions quand on clique hors du champ
document.addEventListener('mousedown', function(e) {
  if (!document.getElementById('autocomplete-list').contains(e.target) &&
      e.target !== document.getElementById('rechercheCommune')) {
    document.getElementById('autocomplete-list').innerHTML = "";
  }
});
    
// 4. Ajoute le contrôle de calque
L.control.layers(null, {
  'Communes ZIP': zipCluster,
  'Communes ZFRR': zrrCluster,
  'Communes GOLD: ZIP+ZFRR': goldCluster,
  'Communes ZAC': zacCluster,
  '🟣 Candidatures (CV)': candidatsLayer
}, { position: 'topleft' }).addTo(map);

    function afficherFormulaireOffre(latlng) {
      var popupContent = 
        `<form id="offreForm">
          <b>Ajouter une offre</b><br>
          <label for="typeOffre"><b>Type d'offre :</b></label><br>
<select id="typeOffre" name="typeOffre" required style="width:100%;padding:6px;border-radius:8px;margin-bottom:8px;">
  <option value="">-- Sélectionner --</option>
  <option value="Médecin généraliste">Médecin généraliste</option>
  <option value="Médecin spécialiste">Médecin spécialiste (spécialité à préciser)</option>
  <option value="Kinésithérapeute">Kinésithérapeute</option>
  <option value="Sage-femme">Sage-femme</option>
  <option value="Infirmier(e) diplômé(e) d’État (IDE)">Infirmier(e) diplômé(e) d’État (IDE)</option>
  <option value="Infirmier(e) Asalée">Infirmier(e) Asalée</option>
  <option value="Orthophoniste">Orthophoniste</option>
  <option value="Orthoptiste">Orthoptiste</option>
  <option value="Psychologue">Psychologue</option>
  <option value="Ergothérapeute">Ergothérapeute</option>
  <option value="Pédicure-podologue">Pédicure-podologue</option>
  <option value="Diététicien(ne)">Diététicien(ne)</option>
  <option value="Psychomotricien(ne)">Psychomotricien(ne)</option>
  <option value="Ostéopathe">Ostéopathe</option>
  <option value="Chirurgien-dentiste">Chirurgien-dentiste</option>
  <option value="Ophtalmologiste">Ophtalmologiste</option>
  <option value="Pharmacien(ne)">Pharmacien(ne)</option>
  <option value="Secrétaire médical(e)">Secrétaire médical(e)</option>
  <option value="Assistant(e) médical(e)">Assistant(e) médical(e)</option>
  <option value="Autre professionnel de santé">Autre professionnel de santé</option>
<option value="Offre d'emploi pluridisciplinaire">Offre d'emploi pluridisciplinaire</option>
</select>
          Nom de la structure :<br><input type="text" name="structure"><br>
          Adresse :<br><input type="text" name="adresse"><br>
          Latitude :<br><input type="text" name="lat" value="${latlng.lat}" readonly><br>
Longitude :<br><input type="text" name="lng" value="${latlng.lng}" readonly><br>
          Description :<br><textarea name="description"></textarea><br>
          Adresse Email (pour recevoir une notification) :<br>
          <input type="email" name="adresseEmail"><br>
          Contact :<br><input type="text" name="contact"><br>
          Photos :<br>
          <input type="text" id="photoURL" name="photos" placeholder="Lien(s) photo..." readonly style="width:70%;"> 
          <button type="button" id="cloudinaryBtn">Uploader des photos</button><br>
          <small>Tous les champs sont optionnels sauf le contact ou l’email, pour qu’on puisse vous joindre !</small><br>
          <div class="g-recaptcha" data-sitekey="6LcL9ZYrAAAAACVHhVg6o6Xyj0_y2uR5X0n-URGb"></div>
          <button type="submit">Publier</button>
        </form>`;
      var popup = L.popup()
        .setLatLng(latlng)
        .setContent(popupContent)
        .openOn(map);

     setTimeout(function() {
  var cloudName = 'damdqxu7t';
  var uploadBtn = document.getElementById('cloudinaryBtn');
  var urlField = document.getElementById('photoURL');
  if (uploadBtn) {
    uploadBtn.onclick = function() {
      cloudinary.openUploadWidget(
        {
          cloudName: cloudName,
          uploadPreset: 'fwmed_unsigned',
          sources: ['local', 'url', 'camera'],
          multiple: true,
          folder: 'offres-farwestmed',
          cropping: false,
          resourceType: 'image',
          maxFileSize: 10485760 // 10MB
        },
        function(error, result) {
          if (!error && result && result.event === "success") {
            let urls = urlField.value ? urlField.value.split(",") : [];
            if (result.info.files && Array.isArray(result.info.files)) {
              urls = urls.concat(result.info.files.map(f => f.uploadInfo.secure_url));
            } else if (result.info.secure_url) {
              urls.push(result.info.secure_url);
            }
            urlField.value = urls.join(",");
          }
        }
      );
    }
  }
 if (window.grecaptcha && document.querySelector('#offreForm .g-recaptcha')) {
  const formEl = document.getElementById('offreForm');
  grecaptcha.render(document.querySelector('#offreForm .g-recaptcha'), {
    sitekey: '6LcL9ZYrAAAAACVHhVg6o6Xyj0_y2uR5X0n-URGb',
    callback: (token)=> formEl.dataset.captcha = token || "",
    'expired-callback': ()=> formEl.dataset.captcha = "",
    'error-callback':   ()=> formEl.dataset.captcha = ""
  });
}
}, 400);

     document.getElementById('offreForm').onsubmit = function(ev) {
  ev.preventDefault();

  if (!canSubmit("offreForm", 5, 60)) {
    showCarteNotification("⚠️ Trop de publications d’offres depuis ce navigateur ! Réessaye dans une heure.");
    return;
  }

  const recaptchaResponse = (ev.target.dataset.captcha || window.getRecaptchaResponse()).trim();
  if (!recaptchaResponse) {
    showCarteNotification("⚠️ Merci de valider le reCAPTCHA avant d’envoyer.");
    return;
  }

  const form = ev.target;
  if (!(form.contact.value || form.adresseEmail.value)) {
    showCarteNotification("⚠️ Veuillez renseigner au moins un moyen de contact (email ou téléphone).");
    return;
  }

  const now = new Date();
  const datePublication = now.toISOString().slice(0, 10);

  const data = {
    "Titre de l’offre": form.typeOffre.value,
    "Nom de la struct": form.structure.value,
    "Adresse": form.adresse.value,
    "Latitude": form.lat.value,
    "Longitude": form.lng.value,
    "Description": form.description.value,
    "Adresse Email": form.adresseEmail.value,
    "Contact": form.contact.value,
    "Photos": form.photos.value,
    "Date de publication": datePublication,
    "Statut": "Publiée"
  };

  fetch(API_OFFRES, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(data)
  }).then(response => {
    if (response.ok) {
      let gallery = "";
      if (form.photos.value) {
        const urls = form.photos.value.split(",");
        gallery = '<div class="photo-gallery">' +
          urls.map(u => u.trim() ? '<img src="'+u.trim()+'" alt="photo" onclick="window.showLightbox(\''+u.trim()+'\')">' : "").join("") +
          '</div>';
      }
      L.marker([form.lat.value, form.lng.value]).addTo(map).bindPopup(
        `<b>${form.typeOffre.value}</b><br>
         ${form.structure.value}<br>
         ${form.adresse.value}<br>
         ${form.description.value}<br>
         ${gallery}
         <b>Contact :</b> ${form.contact.value}<br>
         ${form.adresseEmail.value ? `<b>Email :</b> ${form.adresseEmail.value}<br>` : ""}
         <button type="button" class="btn-postuler" data-email="${form.adresseEmail.value}" data-contact="${form.contact.value}">Postuler à cette offre</button>`
      );
      grecaptcha.reset();
      map.closePopup();
      showCarteNotification("✅ Offre ajoutée !");
    } else {
      showCarteNotification("❌ Erreur lors de l'ajout de l'offre");
    }
  });            // ← ferme .then(...)
};               // ← ferme onsubmit
}     
function afficherFormulaireLocation(latlng) {
  var popupContent = `
    <form id="locationForm">
      <b>Mettre un cabinet ou bureau en location</b><br>
      Adresse :<br>
      <input type="text" name="adresse" required><br>
      Latitude :<br>
      <input type="text" name="lat" value="${latlng.lat}" readonly><br>
      Longitude :<br>
      <input type="text" name="lng" value="${latlng.lng}" readonly><br>
      Description :<br>
      <textarea name="description" required></textarea><br>
      Email :<br>
<input type="email" name="email"><br>
Contact (téléphone) :<br>
      <input type="text" name="contact"><br>
      Photos :<br>
      <input type="text" id="locationPhotoURL" name="photos" placeholder="Lien(s) photo..." readonly style="width:70%;"> 
      <button type="button" id="cloudinaryBtnLocation">Uploader des photos</button><br>
       <div class="g-recaptcha" data-sitekey="6LcL9ZYrAAAAACVHhVg6o6Xyj0_y2uR5X0n-URGb"></div>
      <button type="submit" style="margin-top:8px;">Publier l'annonce</button>
    </form>
  `;
  var popup = L.popup()
    .setLatLng(latlng)
    .setContent(popupContent)
    .openOn(map);

  // Gestion Cloudinary pour photos
 setTimeout(function() {
  var cloudName = 'damdqxu7t';
  var uploadBtn = document.getElementById('cloudinaryBtnLocation');
  var urlField = document.getElementById('locationPhotoURL');
  if (uploadBtn) {
    uploadBtn.onclick = function() {
      cloudinary.openUploadWidget(
        {
          cloudName: cloudName,
          uploadPreset: 'fwmed_unsigned',
          sources: ['local', 'url', 'camera'],
          multiple: true,
          folder: 'locations-farwestmed',
          cropping: false,
          resourceType: 'image',
          maxFileSize: 10485760 // 10MB
        },
        function(error, result) {
          if (!error && result && result.event === "success") {
            let urls = urlField.value ? urlField.value.split(",") : [];
            if (result.info.files && Array.isArray(result.info.files)) {
              urls = urls.concat(result.info.files.map(f => f.uploadInfo.secure_url));
            } else if (result.info.secure_url) {
              urls.push(result.info.secure_url);
            }
            urlField.value = urls.join(",");
          }
        }
      );
    }
  }

 if (window.grecaptcha && document.querySelector('#locationForm .g-recaptcha')) {
  const formEl = document.getElementById('locationForm');
  grecaptcha.render(document.querySelector('#locationForm .g-recaptcha'), {
    sitekey: '6LcL9ZYrAAAAACVHhVg6o6Xyj0_y2uR5X0n-URGb',
    callback: (token)=> formEl.dataset.captcha = token || "",
    'expired-callback': ()=> formEl.dataset.captcha = "",
    'error-callback':   ()=> formEl.dataset.captcha = ""
  });
}
}, 200);
  // Soumission du formulaire location
document.getElementById('locationForm').onsubmit = function(ev){
  ev.preventDefault();
  if (!canSubmit("locationForm", 5, 60)) {
    showCarteNotification("⚠️ Trop de demandes pour ce poste depuis ce navigateur ! Réessaye dans une heure.");
    return;
     }
const recaptchaResponse = (ev.target.dataset.captcha || window.getRecaptchaResponse()).trim();
if (!recaptchaResponse) {
  showCarteNotification("⚠️ Merci de valider le reCAPTCHA avant d’envoyer.");
  return;
}
  var form = ev.target;
  var now = new Date();
  var datePublication = now.toISOString().slice(0, 10);

  var data = {
    Title: "Location via carte", // Tu peux aussi rajouter un champ input pour le titre !
    Adresse: form.adresse.value,
    Latitude: parseFloat(form.lat.value),
    Longitude: parseFloat(form.lng.value),
    Description: form.description.value,
    Email: form.email.value,
    Contact: form.contact.value,
    Photos: form.photos.value,
    Statut: "Publiée",
    "Date de publication": datePublication
  };

  fetch(API_LOCATIONS, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "xc-token": API_TOKEN
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(resp => {
    showCarteNotification("✅ Annonce de location ajoutée !");
    // Ajoute le marker sur la carte si tu veux un retour instantané :
    var locationIcon = L.divIcon({
      html: `<div style="
        font-size:2em;
        width:40px;height:40px;
        border-radius:50%;
        background:#fffbe7;
        border:2px solid #ffe49c;
        display:flex;
        align-items:center;
        justify-content:center;
        box-shadow:0 1px 5px #ffd70077;
      ">🏢</div>`,
      className: '',
      iconSize: [40, 40],
      iconAnchor: [20, 40],
      popupAnchor: [0, -40]
    });
    L.marker([parseFloat(form.lat.value), parseFloat(form.lng.value)], {icon: locationIcon})
      .addTo(map)
      .bindPopup(
        `<b>Cabinet ou bureau à louer</b><br>
        ${form.adresse.value}<br>
        ${form.description.value}<br>
        <b>Contact :</b> ${form.contact.value}<br>
        ${form.email.value ? `<b>Email :</b> ${form.email.value}<br>` : ""}`
      );
    map.closePopup();
  })
  .catch(err => {
    showCarteNotification("❌ Erreur réseau : " + err);
    console.error("Erreur réseau : ", err);
  });
};
}
    function afficherFormulaireCandidat(latlng) {
  const html = `
    <form id="candidatForm">
      <b>Déposer ma candidature</b><br>
      Nom / Prénom :<br><input type="text" name="Nom" required><br>
      Emploi recherché :<br>
      <select name="Emploi recherché" required>
        <option value="">-- Sélectionner --</option>
        <option>Médecin généraliste</option>
        <option>Médecin spécialiste</option>
        <option>Infirmier(e)</option>
        <option>Kinésithérapeute</option>
        <option>Chirurgien-dentiste</option>
        <option>Orthophoniste</option>
        <option>Orthoptiste</option>
        <option>Psychologue</option>
        <option>Autre professionnel de santé</option>
      </select><br>
      Disponibilité :<br><input type="text" name="Disponibilité" required><br>
      (Optionnel) Zone souhaitée :<br><input type="text" name="Zone"><br>
      Description :<br><textarea name="Description"></textarea><br>
      Email :<br><input type="email" name="Email" required><br>
      Téléphone :<br><input type="text" name="Téléphone"><br>
      <div class="g-recaptcha" data-sitekey="6LcL9ZYrAAAAACVHhVg6o6Xyj0_y2uR5X0n-URGb"></div>
      <button type="submit" style="margin-top:8px;">Publier ma candidature</button>
    </form>`;
  L.popup().setLatLng(latlng).setContent(html).openOn(map);

  setTimeout(()=>{
  if (window.grecaptcha && document.querySelector('#candidatForm .g-recaptcha')) {
    const formEl = document.getElementById('candidatForm');
    grecaptcha.render(document.querySelector('#candidatForm .g-recaptcha'), {
      sitekey: '6LcL9ZYrAAAAACVHhVg6o6Xyj0_y2uR5X0n-URGb',
      callback: (token)=> formEl.dataset.captcha = token || "",
      'expired-callback': ()=> formEl.dataset.captcha = "",
      'error-callback':   ()=> formEl.dataset.captcha = ""
    });
  }
}, 150);

  document.getElementById('candidatForm').onsubmit = function(ev) {
  ev.preventDefault();

  if (!canSubmit("candidatForm", 5, 60)) {
    showCarteNotification("⚠️ Trop de publications depuis ce navigateur, réessaie dans 1h.");
    return;
  }

  const recaptchaResponse = (ev.target.dataset.captcha || window.getRecaptchaResponse()).trim();
  if (!recaptchaResponse) {
    showCarteNotification("⚠️ Merci de valider le reCAPTCHA.");
    return;
  }

  const f = ev.target;
  const payload = {
    "Title": "Candidature via carte",
    "Nom": f.Nom.value,
    "Emploi recherché": f["Emploi recherché"].value,
    "Disponibilité": f["Disponibilité"].value,
    "Zone": f.Zone.value,
    "Description": f.Description.value,
    "Email": f.Email.value,
    "Téléphone": f["Téléphone"].value,
    "Latitude": latlng.lat,
    "Longitude": latlng.lng,
    "Statut": "Publiée"
  };

  fetch(API_CANDIDATS, {
    method: "POST",
    headers: { "Content-Type":"application/json", "xc-token": API_TOKEN },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(() => {
    showCarteNotification("✅ Candidature ajoutée !");
    // Affichage immédiat sur la carte
    const emploi = payload["Emploi recherché"];
    const tel = payload["Téléphone"];
    L.marker([latlng.lat, latlng.lng], {icon: candidateIcon})
      .addTo(candidatsLayer)
      .bindPopup(
        `<b>Candidature – ${emploi}</b><br>
         ${payload.Nom}<br>
         ${payload.Zone ? `Zone souhaitée : ${payload.Zone}<br>` : ''}
         Dispo : ${payload["Disponibilité"]}<br>
         ${addLineBreaksBeforeEmoji(forceLineBreaksAfterDot(nl2br(payload.Description||'')))}<br>
         <b>Contact :</b> ${payload.Email}${tel ? ' · ' + tel : ''}`
      );
    grecaptcha.reset();
    map.closePopup();
  })
  .catch(() => showCarteNotification("❌ Erreur lors de l'ajout."));
};
      } 
map.on('click', function(e) {
  var latlng = e.latlng;
  var popupContent = `
    <b>Que souhaitez-vous faire&nbsp;?</b><br><br>
    <button id="btnDeposerOffre" style="background:#f9d875;color:#4b3c10;padding:8px 18px;font-size:1em;border-radius:8px;border:none;cursor:pointer;margin-bottom:12px;font-weight:bold;">
      Déposer une offre d'emploi
    </button><br>
    <button id="btnProposerLocation" style="background:#fffbe7;color:#554400;padding:8px 18px;font-size:1em;border-radius:8px;border:1px solid #ffe49c;cursor:pointer;font-weight:bold;">
      Mettre un cabinet ou bureau en location
    </button>
    <button id="btnDeposerCandidature"
      style="background:#e9ddff;color:#4b2aa5;padding:8px 18px;font-size:1em;border-radius:8px;border:1px solid #c9b5ff;cursor:pointer;font-weight:bold;margin-top:10px;">
      Déposer ma candidature
    </button>
  `;
  var popup = L.popup()
    .setLatLng(latlng)
    .setContent(popupContent)
    .openOn(map);

  // ⬇️ On force un délai de 600ms pour être certain que le DOM est prêt
  setTimeout(function() {
    var btnDeposer = document.getElementById('btnDeposerOffre');
    var btnLoc = document.getElementById('btnProposerLocation');
    // DEBUG
    console.log('btnDeposer:', btnDeposer, 'btnLoc:', btnLoc);

    if (btnDeposer) {
      btnDeposer.onclick = function() {
        afficherFormulaireOffre(latlng);
      };
    }
   if (btnLoc) {
  btnLoc.onclick = function() {
    afficherFormulaireLocation(latlng);
  };
}

// bouton "Déposer ma candidature"
var btnCand = document.getElementById('btnDeposerCandidature');
if (btnCand) {
  btnCand.onclick = function() {
    afficherFormulaireCandidat(latlng);
  };
}

}, 600);
});
   
  </script>
  <script>console.log('[A] FIN bloc 1');</script>
  
  <script>console.log('[B] Début bloc 2');</script>
  <script>
function toggleSidebar() {
  var sb = document.getElementById('sidebar-mode-emploi');
  var btn = document.getElementById('sidebar-toggle-btn');
  var arrow = document.getElementById('toggle-arrow');

  sb.classList.toggle('open');
  sb.classList.toggle('closed');

  const opened = sb.classList.contains('open');
  arrow.innerHTML = opened ? '&#9664;' : '&#9654;'; // ◀ si ouvert, ▶ si fermé
  btn.setAttribute('aria-label', opened ? "Masquer le mode d'emploi" : "Afficher le mode d'emploi");

  // Laisse Leaflet recalculer la taille, puis ajuste légèrement la vue
  setTimeout(function(){
    map.invalidateSize();
    if (opened) {
      const size = map.getSize();
      map.panBy([size.x * 0.12, 0], { animate: true }); // petit décalage à l’ouverture
    } else {
      const size = map.getSize();
      map.panBy([-size.x * 0.12, 0], { animate: true }); // on “recolle” en fermeture
    }
  }, 250);
}
</script>
  <script src="https://www.google.com/recaptcha/api.js"></script>
  <script>console.log('[B] FIN bloc 2');</script>
  <script>console.log('[C] Début bloc 3');</script>
<script>
// Remplace TOUT le listener existant par ceci
document.body.addEventListener('click', async function(e) {
  const btn = e.target?.closest('.btn-partager');
  if (!btn) return;

  e.stopPropagation();

  const lat  = btn.getAttribute('data-lat');
  const lng  = btn.getAttribute('data-lng');
  const zoom = 15;

  // URL partage: toujours absolue
  const base = location.origin + location.pathname;
  const url  = `${base}?lat=${encodeURIComponent(lat)}&lng=${encodeURIComponent(lng)}&zoom=${zoom}`;

  // Élément du petit menu (créé dans le HTML du popup)
  const menu = btn.parentNode.querySelector('.popup-share-menu');

  // Si déjà ouvert -> toggle off
  if (menu.style.display === 'block') {
    menu.style.display = 'none';
    menu.innerHTML = '';
    return;
  }

  // 1) Web Share natif SI ET SEULEMENT SI on n'est PAS dans un iframe
  const canWebShare = !!navigator.share && (window.top === window.self);
  if (canWebShare) {
    try {
      await navigator.share({
        title: 'FarWestMed',
        text: 'Découvre cette annonce sur FarWestMed :',
        url
      });
      return; // succès natif => on sort
    } catch (_) {
      // si l’utilisateur annule, on ne fait rien; si ça jette, on tombera en fallback
    }
  }

  // 2) Fallback (desktop ou iOS en iframe)
  menu.innerHTML = `
    <div style="background:#fffbe7;border:1px solid #bbe7ff;padding:10px 15px;border-radius:12px;box-shadow:0 4px 12px #0002;position:absolute;right:0;top:30px;">
      <b>Partager via :</b><br>
      <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}" target="_blank" rel="noopener">Facebook</a> &nbsp;|&nbsp;
      <a href="https://wa.me/?text=${encodeURIComponent(url)}" target="_blank" rel="noopener">WhatsApp</a> &nbsp;|&nbsp;
      <a href="mailto:?subject=Annonce%20FarWestMed&body=${encodeURIComponent(url)}">Mail</a>
      <br>
      <button style="font-size:0.95em;margin-top:6px;"
              onclick="navigator.clipboard.writeText('${url}').then(()=>{this.textContent='Lien copié !'})">
        Copier le lien
      </button>
    </div>
  `;
  menu.style.display = 'block';

  // 3) S'assurer que le menu est VISIBLE :
  //    a) on scrolle l'intérieur du popup (wrapper)
  //    b) si le bas du popup dépasse l'écran, on pan la carte vers le haut
  requestAnimationFrame(() => {
    const content = btn.closest('.leaflet-popup-content');
    const wrapper = content ? content.parentElement : null; // .leaflet-popup-content-wrapper
    const scroller =
      (content && content.scrollHeight > content.clientHeight && content) ||
      (wrapper && wrapper.scrollHeight > wrapper.clientHeight && wrapper) ||
      wrapper || content;

    try {
      scroller && (scroller.scrollTop = scroller.scrollHeight);
    } catch {}

    // Pan de la carte si le popup déborde en bas
    try {
      const popupEl = btn.closest('.leaflet-popup');
      if (popupEl) {
        const rect = popupEl.getBoundingClientRect();
        const pad  = 10;
        const overflow = rect.bottom - (window.innerHeight - pad);
        if (overflow > 0 && window.map && typeof window.map.panBy === 'function') {
          window.map.panBy([0, -(overflow + 20)], { animate: true });
        }
      }
    } catch {}
  });

  // 4) clic hors du menu => le fermer
  setTimeout(() => {
    function closeMenu(ev) {
      if (!menu.contains(ev.target) && ev.target !== btn) {
        menu.style.display = 'none';
        menu.innerHTML = '';
        document.removeEventListener('mousedown', closeMenu, true);
        document.removeEventListener('touchstart', closeMenu, true);
      }
    }
    document.addEventListener('mousedown', closeMenu, true);
    document.addEventListener('touchstart', closeMenu, true);
  }, 80);
});
</script>
  <script>console.log('[C] FIN bloc 3');</script>
  <script>
  function appendContactBlock(btnEl, title) {
  const email = btnEl.getAttribute('data-email') || '';
  const contact = btnEl.getAttribute('data-contact') || '';
  const popup = btnEl.closest('.leaflet-popup-content');
  if (!popup) return;

  // évite les doublons
  let existing = popup.querySelector('.fwmed-contact-block');
  if (!existing) {
    existing = document.createElement('div');
    existing.className = 'fwmed-contact-block';
    existing.style.marginTop = '10px';
    existing.style.padding = '10px 12px';
    existing.style.border = '1px solid #ffe49c';
    existing.style.background = '#fffbe7';
    existing.style.borderRadius = '10px';
    popup.appendChild(existing);
  }

  let html = `<b>${title}</b><br>`;
  if (email)  html += `📧 ${email}<br>`;
  if (contact) html += `📞 ${contact}<br>`;
  if (!email && !contact) html += '❌ Aucun contact renseigné.';

  existing.innerHTML = html;

  // petit confort : scroll vers le bas du popup
  setTimeout(()=> popup.parentElement?.scrollTo?.({ top: popup.scrollHeight, behavior: 'smooth' }), 50);
}

// Offres : "Postuler à cette offre"
document.body.addEventListener('click', function(e) {
  if (e.target && e.target.classList.contains('btn-postuler')) {
    appendContactBlock(e.target, 'Contact :');
  }
});

// Locations : "Ça m’intéresse"
document.body.addEventListener('click', function(e) {
  if (e.target && e.target.classList.contains('btn-interesse-location')) {
    appendContactBlock(e.target, 'Contact propriétaire :');
  }
});
</script>
   <script>
// Patch pour propagation correcte du click natif sur mobile (iOS & Android)
// à placer à la fin de ton code JS !
(function() {
  let lastTouchTime = 0;
  document.body.addEventListener('touchend', function(e) {
    const target = e.target;
    if (target && target.classList && target.classList.contains('btn-partager')) {
      const now = Date.now();
      if (now - lastTouchTime < 400) return; // anti double trigger
      lastTouchTime = now;
     setTimeout(function() {
  const menu = target.parentNode.querySelector('.popup-share-menu');
  if (menu && menu.style.display !== 'block') {
    // Créé un vrai événement click natif
    const evt = new MouseEvent('click', {
      bubbles: true,
      cancelable: true,
      view: window
    });
    target.dispatchEvent(evt);
  }
}, 0);
    }
  }, {passive: true});
})();
</script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const sb = document.getElementById('sidebar-mode-emploi');
      const arrow = document.getElementById('toggle-arrow');
      if (sb) {
        sb.classList.remove('open');
        sb.classList.add('closed');
      }
      if (arrow) arrow.innerHTML = '&#9654;'; // ▶
    });
  </script>
  <!-- Mobile publish CTA -->
<button id="mobile-publish-btn" style="display:none">➕ Déposer une annonce</button>

<!-- Bottom sheet mobile -->
<div id="mobile-sheet-backdrop"></div>
<div id="mobile-sheet" aria-modal="true" role="dialog" aria-labelledby="ms-title">
  <div class="ms-header">
    <div class="ms-title" id="ms-title">Déposer une annonce</div>
    <div style="margin-left:auto"><button id="ms-close" class="btn-secondary">Fermer</button></div>
  </div>
  <div class="ms-body">
    <!-- Step 1: Type -->
    <div class="step" id="ms-step-1">
      <div class="field">
        <label>Type d’annonce</label>
        <div class="chips" id="ms-type-chips">
          <div class="chip" data-value="Offre d'emploi">Offre d’emploi</div>
          <div class="chip" data-value="Location">Cabinet à louer</div>
          <div class="chip" data-value="Candidature">Candidature (CV)</div>
        </div>
      </div>
      <div class="small-help">Tu pourras préciser la profession à l’étape suivante.</div>
    </div>

    <!-- Step 2: Position / Adresse -->
    <div class="step" id="ms-step-2">
      <div class="field">
        <label>Adresse ou commune</label>
        <input id="ms-address" type="text" placeholder="Ex: 10 rue de la Paix, Paris" autocomplete="off">
        <div id="ms-address-suggest" class="mini"></div>
      </div>
      <div class="inline">
        <button id="ms-geolocate" class="btn-secondary" type="button">📍 Ma position</button>
        <div class="mini" id="ms-latlng" aria-live="polite"></div>
      </div>
    </div>

 <!-- Step 3: Détails -->
<div class="step" id="ms-step-3">
  <!-- Détails spécifiques offre -->
  <div id="ms-details-offre" style="display:none">
    <div class="field" id="ms-field-offre-prof">
      <label>Profession</label>
      <select id="ms-profession">
        <option value="">-- Sélectionner --</option>
        <option>Médecin généraliste</option>
        <option>Médecin spécialiste</option>
        <option>Kinésithérapeute</option>
        <option>Infirmier(e) diplômé(e) d’État (IDE)</option>
        <option>Orthophoniste</option>
        <option>Orthoptiste</option>
        <option>Psychologue</option>
        <option>Chirurgien-dentiste</option>
        <option>Pharmacien(ne)</option>
        <option>Autre professionnel de santé</option>
        <option>Offre d'emploi pluridisciplinaire</option>
      </select>
    </div>

    <div class="field" id="ms-field-offre-struct">
      <label>Nom de la structure</label>
      <input id="ms-struct" type="text">
    </div>

    <div class="field" id="ms-field-offre-desc">
      <label>Description</label>
      <textarea id="ms-desc" rows="4"></textarea>
    </div>

    <div class="field" id="ms-field-offre-photos">
      <label>Photos</label>
      <div class="inline">
        <input id="ms-photos" type="text" placeholder="Liens Cloudinary…" readonly>
        <button id="ms-upload" class="btn-secondary" type="button">Uploader</button>
      </div>
    </div>

    <div class="field" id="ms-field-offre-email">
      <label>Email</label>
      <input id="ms-email" type="email">
    </div>

    <div class="field" id="ms-field-offre-contact">
      <label>Contact (téléphone)</label>
      <input id="ms-contact" type="text">
    </div>

    <div class="field" id="ms-field-offre-captcha">
      <div class="g-recaptcha" id="ms-recaptcha" data-sitekey="6LcL9ZYrAAAAACVHhVg6o6Xyj0_y2uR5X0n-URGb"></div>
    </div>
  </div>

  <!-- Détails spécifiques location -->
  <div id="ms-details-location" style="display:none">
    <div class="field" id="ms-field-loc-desc">
      <label>Description</label>
      <textarea id="ms-desc-loc" rows="4"></textarea>
    </div>

    <div class="field" id="ms-field-loc-photos">
      <label>Photos</label>
      <div class="inline">
        <input id="ms-photos-loc" type="text" placeholder="Liens Cloudinary…" readonly>
        <button id="ms-upload-loc" class="btn-secondary" type="button">Uploader</button>
      </div>
    </div>

    <div class="field" id="ms-field-loc-email">
      <label>Email</label>
      <input id="ms-email-loc" type="email">
    </div>

    <div class="field" id="ms-field-loc-contact">
      <label>Contact (téléphone)</label>
      <input id="ms-contact-loc" type="text">
    </div>

    <div class="field" id="ms-field-loc-captcha">
      <div class="g-recaptcha" id="ms-recaptcha-loc" data-sitekey="6LcL9ZYrAAAAACVHhVg6o6Xyj0_y2uR5X0n-URGb"></div>
    </div>
  </div>

  <!-- Détails spécifiques candidature -->
  <div id="ms-details-cand" style="display:none">
    <div class="field" id="ms-field-cand-name">
      <label>Nom / Prénom</label>
      <input id="ms-cand-name" type="text">
    </div>

    <div class="field" id="ms-field-cand-prof">
      <label>Profession</label>
      <select id="ms-cand-prof">
        <option value="">-- Sélectionner --</option>
        <option>Médecin généraliste</option>
        <option>Médecin spécialiste</option>
        <option>Infirmier(e)</option>
        <option>Kinésithérapeute</option>
        <option>Chirurgien-dentiste</option>
        <option>Orthophoniste</option>
        <option>Orthoptiste</option>
        <option>Psychologue</option>
        <option>Autre professionnel de santé</option>
      </select>
    </div>

    <div class="field" id="ms-field-cand-dispo">
      <label>Disponibilité</label>
      <input id="ms-cand-dispo" type="text" placeholder="Ex: dès octobre">
    </div>

    <div class="field" id="ms-field-cand-zone">
      <label>Zone souhaitée (optionnel)</label>
      <input id="ms-cand-zone" type="text">
    </div>

    <div class="field" id="ms-field-cand-desc">
      <label>Description</label>
      <textarea id="ms-cand-desc" rows="4"></textarea>
    </div>

    <div class="field" id="ms-field-cand-email">
      <label>Email</label>
      <input id="ms-cand-email" type="email">
    </div>

    <div class="field" id="ms-field-cand-tel">
      <label>Téléphone</label>
      <input id="ms-cand-tel" type="text">
    </div>

    <div class="field" id="ms-field-cand-captcha">
      <div class="g-recaptcha" id="ms-recaptcha-cand" data-sitekey="6LcL9ZYrAAAAACVHhVg6o6Xyj0_y2uR5X0n-URGb"></div>
       </div> <!-- /#ms-field-cand-captcha -->
  </div>   <!-- /#ms-details-cand -->
</div>     <!-- /#ms-step-3 -->

<div class="ms-actions">
  <button id="ms-prev" class="btn-secondary" type="button">Retour</button>
  <button id="ms-skip" class="btn-secondary" type="button" style="display:none">Passer</button>
  <button id="ms-next" class="btn-primary" type="button">Continuer</button>
</div>

</div> <!-- /.ms-body -->
</div> <!-- /#mobile-sheet -->

  <script>
(function(){
  const isMobile = window.matchMedia('(max-width:700px)').matches;

  // 3.a Désactiver le flux "clic carte → formulaire" sur mobile (on garde la carte pour consulter)
  if(isMobile){
    // neutralise l’ouverture du popup d’ajout au clic
    map.off('click');
  }

  // 3.b Bouton flottant visible uniquement sur mobile
  const btn = document.getElementById('mobile-publish-btn');
  if(btn) btn.style.display = isMobile ? 'block' : 'none';

  // Réfs UI
  const backdrop = document.getElementById('mobile-sheet-backdrop');
  const sheet    = document.getElementById('mobile-sheet');
  const closeBtn = document.getElementById('ms-close');
  const nextBtn  = document.getElementById('ms-next');
  const prevBtn  = document.getElementById('ms-prev');
  const skipBtn = document.getElementById('ms-skip');
prevBtn.onclick = gotoPrevField;
nextBtn.onclick = handleNext;
skipBtn.onclick = function(){
  // passer uniquement les champs non requis
  const id = state._seq[state._idx];
  if (id && !REQUIRED.has(id)) gotoNextField();
};

  const stepEls = [1,2,3].map(i => document.getElementById('ms-step-' + i));

  const state = {
    step: 1,
    type: null,              // 'Offre d\'emploi' | 'Location' | 'Candidature'
    address: '', lat: null, lng: null,
    // détails offre
    profession: '', struct:'', desc:'', photos:'', email:'', contact:'',
    // location
    descLoc:'', photosLoc:'', emailLoc:'', contactLoc:'',
    // candidature
    candName:'', candProf:'', candDispo:'', candZone:'', candDesc:'', candEmail:'', candTel:''
  };
  // ⬇️ Ici tu colles le bloc FIELD_SEQ / REQUIRED / isContactPair
// Sous-étapes (questions) de l'étape 3
const FIELD_SEQ = {
  "Offre d'emploi": [
    "ms-field-offre-prof",     // requis
    "ms-field-offre-struct",   // optionnel
    "ms-field-offre-desc",     // optionnel
    "ms-field-offre-photos",   // optionnel
    "ms-field-offre-email",    // email/tel au moins un requis
    "ms-field-offre-contact",  // email/tel au moins un requis
    "ms-field-offre-captcha"   // requis
  ],
  "Location": [
    "ms-field-loc-desc",       // requis
    "ms-field-loc-photos",     // optionnel
    "ms-field-loc-email",      // email/tel au moins un requis
    "ms-field-loc-contact",    // email/tel au moins un requis
    "ms-field-loc-captcha"     // requis
  ],
  "Candidature": [
    "ms-field-cand-name",      // requis
    "ms-field-cand-prof",      // requis
    "ms-field-cand-dispo",     // optionnel
    "ms-field-cand-zone",      // optionnel
    "ms-field-cand-desc",      // optionnel
    "ms-field-cand-email",     // requis
    "ms-field-cand-tel",       // optionnel
    "ms-field-cand-captcha"    // requis
  ]
};

const REQUIRED = new Set([
  "ms-field-offre-prof",
  "ms-field-offre-captcha",
  "ms-field-loc-desc",
  "ms-field-loc-captcha",
  "ms-field-cand-name",
  "ms-field-cand-prof",
  "ms-field-cand-email",
  "ms-field-cand-captcha"
]);

function isContactPair(section) {
  if (section.startsWith("ms-field-offre-")) return ["ms-email","ms-contact"];
  if (section.startsWith("ms-field-loc-"))   return ["ms-email-loc","ms-contact-loc"];
  return null;
}
  

  function openSheet(){
  backdrop.style.display = 'block';
  sheet.classList.add('open');
  try { map.closePopup(); } catch (_) {} // ferme popups ouverts
  document.getElementById('map').style.pointerEvents = 'none';  
  showStep(1);
  renderReCaptchaIfNeeded();
}

function closeSheet(){
  sheet.classList.remove('open');
  setTimeout(()=> backdrop.style.display='none', 200);
  document.getElementById('map').style.pointerEvents = '';      
}
  function showStep(n){
  state.step = n;
  stepEls.forEach((el,i)=> el.classList.toggle('active', i === (n-1)));
  prevBtn.style.visibility = (n===1 ? 'hidden' : 'visible');
  skipBtn.style.display = 'none';
  nextBtn.textContent = 'Continuer';

  // Affiche les 3 sous-sections conteneurs (mais on masquera les champs dedans)
  document.getElementById('ms-details-offre').style.display     = (state.type === "Offre d'emploi") ? 'block' : 'none';
  document.getElementById('ms-details-location').style.display  = (state.type === "Location") ? 'block' : 'none';
  document.getElementById('ms-details-cand').style.display      = (state.type === "Candidature") ? 'block' : 'none';

  if(n !== 3){
    renderReCaptchaIfNeeded();
    return;
  }

  // === Étape 3 : on prépare la séquence “une question à la fois” ===
  state._seq = FIELD_SEQ[state.type] || [];
  state._idx = 0;

  // cache tous les champs
  document.querySelectorAll('#ms-step-3 .field').forEach(el => el.style.display = 'none');
  // montre le premier
  showCurrentField();
}
  function showCurrentField(){
  // masque tout
  document.querySelectorAll('#ms-step-3 .field').forEach(el => el.style.display = 'none');

  const id = state._seq[state._idx];
  const el = document.getElementById(id);
  if(!id || !el){
    // plus de questions -> on bascule le bouton en “Publier”
    nextBtn.textContent = (state.type === "Location")
      ? 'Publier la location'
      : (state.type === "Candidature" ? 'Publier ma candidature' : 'Publier l’offre');
    skipBtn.style.display = 'none';
    return;
  }

  // afficher le champ courant
  el.style.display = 'block';

  // libellé du bouton principal
  const last = state._idx === state._seq.length - 1;
  nextBtn.textContent = last
    ? (state.type === "Location" ? 'Publier la location'
       : (state.type === "Candidature" ? 'Publier ma candidature' : 'Publier l’offre'))
    : 'Continuer';

  // bouton "Passer" seulement si non requis
  const isRequired = REQUIRED.has(id);
  skipBtn.style.display = isRequired ? 'none' : 'inline-block';

  // rendre recaptcha si c’est ce champ
  renderReCaptchaIfNeeded();
}

function gotoNextField(){
  if (state._idx < (state._seq.length - 1)) {
    state._idx++;
    showCurrentField();
  } else {
    // fin des questions -> tenter la soumission
    submitStep3();
  }
}

function gotoPrevField(){
  if (state.step === 3 && state._idx > 0){
    state._idx--;
    showCurrentField();
  } else {
    showStep(Math.max(1, state.step-1));
  }
}

  btn && btn.addEventListener('click', openSheet);
  backdrop.addEventListener('click', closeSheet);
  closeBtn.addEventListener('click', closeSheet);
  

  // Step 1 — choix du type + passage auto à l'étape suivante
function typeChipHandler(e){
  const chip = e.target.closest('.chip'); if(!chip) return;
  document.querySelectorAll('#ms-type-chips .chip').forEach(c=>c.classList.remove('active'));
  chip.classList.add('active');
  state.type = chip.dataset.value;
  showStep(2); // avance tout de suite après le choix
}

['click','touchend'].forEach(evt =>
  document.getElementById('ms-type-chips').addEventListener(evt, typeChipHandler, {passive:true})
);

  // Step 2 — adresse / position
  const addrInput = document.getElementById('ms-address');
  const addrSuggest = document.getElementById('ms-address-suggest');
  const latlngEl = document.getElementById('ms-latlng');

  addrInput.addEventListener('input', async function(){
    const q = this.value.trim();
    state.address = q;
    if(q.length < 3){ addrSuggest.textContent = ''; return; }
    try{
      const r = await fetch('https://api-adresse.data.gouv.fr/search/?q='+encodeURIComponent(q)+'&limit=5');
      const j = await r.json();
      if(!j.features?.length){ addrSuggest.textContent = 'Aucune suggestion…'; return; }
      addrSuggest.innerHTML = j.features.map(f=>`<div class="suggest" data-lon="${f.geometry.coordinates[0]}" data-lat="${f.geometry.coordinates[1]}">${f.properties.label}</div>`).join('');
    }catch(_){ addrSuggest.textContent = 'Erreur de suggestion'; }
  });

  addrSuggest.addEventListener('click', (e)=>{
    const s = e.target.closest('.suggest'); if(!s) return;
    const label = s.textContent;
    state.address = label;
    state.lat = parseFloat(s.dataset.lat);
    state.lng = parseFloat(s.dataset.lon);
    addrInput.value = label;
    addrSuggest.innerHTML = '';
    latlngEl.textContent = `OK • ${state.lat.toFixed(5)}, ${state.lng.toFixed(5)}`;
  });

  document.getElementById('ms-geolocate').addEventListener('click', ()=>{
    if(!navigator.geolocation){ latlngEl.textContent = 'Géoloc non disponible'; return; }
    latlngEl.textContent = 'Recherche de ta position…';
    navigator.geolocation.getCurrentPosition(
      async (pos)=>{
        state.lat = pos.coords.latitude; state.lng = pos.coords.longitude;
        latlngEl.textContent = `OK • ${state.lat.toFixed(5)}, ${state.lng.toFixed(5)}`;
        // reverse-geocoding pour remplir l’adresse
        try{
          const r = await fetch(`https://api-adresse.data.gouv.fr/reverse/?lat=${state.lat}&lon=${state.lng}`);
          const j = await r.json();
          const label = j.features?.[0]?.properties?.label || '';
          if(label){ addrInput.value = label; state.address = label; }
        }catch(_){}
      },
      ()=> latlngEl.textContent = 'Impossible d’obtenir la position'
    );
  });

  // Step 3 — uploads & champs
  // Cloudinary (réutilise ton widget)
  function openUpload(targetInputId, folder){
    const urlField = document.getElementById(targetInputId);
    cloudinary.openUploadWidget(
      {
        cloudName: 'damdqxu7t',
        uploadPreset: 'fwmed_unsigned',
        sources: ['local','url','camera'],
        multiple: true, folder, cropping: false, resourceType:'image',
        maxFileSize: 10485760
      },
      function(error, result){
        if(!error && result && result.event === 'success'){
          let urls = urlField.value ? urlField.value.split(',') : [];
          if (result.info.files && Array.isArray(result.info.files)) {
            urls = urls.concat(result.info.files.map(f => f.uploadInfo.secure_url));
          } else if (result.info.secure_url) { urls.push(result.info.secure_url); }
          urlField.value = urls.join(',');
        }
      }
    );
  }
  document.getElementById('ms-upload').addEventListener('click', ()=> openUpload('ms-photos','offres-farwestmed'));
  document.getElementById('ms-upload-loc').addEventListener('click', ()=> openUpload('ms-photos-loc','locations-farwestmed'));

  // reCAPTCHA
// — reCAPTCHA (PATCH iOS / mobile) —
let recaptchaIds   = { offre:null, loc:null, cand:null };
let recaptchaToken = { offre:"",   loc:"",   cand:""   };

function renderReCaptchaIfNeeded(){
  if(!window.grecaptcha || !grecaptcha.render) return;
  if(state.step !== 3) return;

  const mkOpts = (type) => ({
    sitekey: '6LcL9ZYrAAAAACVHhVg6o6Xyj0_y2uR5X0n-URGb',
    callback: (token)=>{ recaptchaToken[type] = token || ""; },
    'expired-callback': ()=>{ recaptchaToken[type] = ""; },
    'error-callback':   ()=>{ recaptchaToken[type] = ""; }
  });

  if(state.type === "Offre d'emploi" && !recaptchaIds.offre){
    recaptchaIds.offre = grecaptcha.render('ms-recaptcha', mkOpts('offre'));
  }
  if(state.type === "Location" && !recaptchaIds.loc){
    recaptchaIds.loc = grecaptcha.render('ms-recaptcha-loc', mkOpts('loc'));
  }
  if(state.type === "Candidature" && !recaptchaIds.cand){
    recaptchaIds.cand = grecaptcha.render('ms-recaptcha-cand', mkOpts('cand'));
  }
}

function getRecaptchaResponse(){
  // 1) on privilégie le jeton capturé (fiable iOS)
  if(state.type === "Offre d'emploi" && recaptchaToken.offre) return recaptchaToken.offre;
  if(state.type === "Location"        && recaptchaToken.loc)   return recaptchaToken.loc;
  if(state.type === "Candidature"     && recaptchaToken.cand)  return recaptchaToken.cand;

  // 2) fallback (rarement utile)
  try{
    if(state.type === "Offre d'emploi" && recaptchaIds.offre!=null) return grecaptcha.getResponse(recaptchaIds.offre);
    if(state.type === "Location"        && recaptchaIds.loc!=null)   return grecaptcha.getResponse(recaptchaIds.loc);
    if(state.type === "Candidature"     && recaptchaIds.cand!=null)  return grecaptcha.getResponse(recaptchaIds.cand);
  }catch(_){}
  return "";
}

function resetRecaptcha(){
  try{
    if(state.type === "Offre d'emploi" && recaptchaIds.offre!=null) grecaptcha.reset(recaptchaIds.offre);
    if(state.type === "Location"        && recaptchaIds.loc!=null)   grecaptcha.reset(recaptchaIds.loc);
    if(state.type === "Candidature"     && recaptchaIds.cand!=null)  grecaptcha.reset(recaptchaIds.cand);
  }catch(_){}
  recaptchaToken.offre = recaptchaToken.loc = recaptchaToken.cand = "";
}

  // Navigation
  async function submitStep3(){
 const captcha = getRecaptchaResponse();
    console.log('captcha token:', captcha && captcha.slice(0,12)+'…');
  if(!captcha){ showCarteNotification("Merci de valider le reCAPTCHA."); return; }
     if(!canSubmit("mobileSheetSubmit", 5, 60)){
    showCarteNotification("⚠️ Trop de publications depuis ce navigateur. Réessaie dans 1 heure.");
    return;
  }

  const datePublication = (new Date()).toISOString().slice(0,10);

  try{
    if(state.type === "Offre d'emploi"){
      // vérif pair email/tel (au moins un)
      if(!(state.email || state.contact)){
        showCarteNotification("Ajoute un email ou un téléphone."); return;
      }
      if(!state.profession){ showCarteNotification("Choisis la profession."); return; }

      const payload = {
        "Titre de l’offre": state.profession,
        "Nom de la struct": state.struct,
        "Adresse": state.address,
        "Latitude": state.lat,
        "Longitude": state.lng,
        "Description": state.desc,
        "Adresse Email": state.email,
        "Contact": state.contact,
        "Photos": state.photos,
        "Date de publication": datePublication,
        "Statut": "Publiée"
      };
      const r = await fetch(API_OFFRES, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(payload) });
      if(!r.ok) throw new Error('POST offres échoué');
    }
    else if(state.type === "Location"){
      if(!(state.emailLoc || state.contactLoc)){
        showCarteNotification("Ajoute un email ou un téléphone."); return;
      }
      if(!state.descLoc){ showCarteNotification("Ajoute une description."); return; }

      const payload = {
        Title: "Location via mobile",
        Adresse: state.address,
        Latitude: state.lat, Longitude: state.lng,
        Description: state.descLoc, Email: state.emailLoc, Contact: state.contactLoc,
        Photos: state.photosLoc, Statut: "Publiée", "Date de publication": datePublication
      };
      const r = await fetch(API_LOCATIONS, { method:'POST', headers:{'Content-Type':'application/json','xc-token':API_TOKEN}, body: JSON.stringify(payload) });
      if(!r.ok) throw new Error('POST locations échoué');
    }
    else { // Candidature
      if(!state.candEmail){ showCarteNotification("Ajoute un email pour être contacté."); return; }
      if(!state.candProf){ showCarteNotification("Choisis une profession."); return; }

      const payload = {
        "Title": "Candidature via mobile",
        "Nom": state.candName, "Emploi recherché": state.candProf, "Disponibilité": state.candDispo,
        "Zone": state.candZone, "Description": state.candDesc, "Email": state.candEmail, "Téléphone": state.candTel,
        "Latitude": state.lat, "Longitude": state.lng, "Statut": "Publiée"
      };
      const r = await fetch(API_CANDIDATS, { method:'POST', headers:{'Content-Type':'application/json','xc-token':API_TOKEN}, body: JSON.stringify(payload) });
      if(!r.ok) throw new Error('POST candidats échoué');
    }

    resetRecaptcha();
    closeSheet();
    showCarteNotification("✅ Annonce publiée !");
  }catch(err){
    console.error(err);
    showCarteNotification("❌ Erreur d’envoi. Réessaie.");
  }
}
async function handleNext(){
  // Étape 1 → choix type
  if(state.step === 1){
    if(!state.type){
      showCarteNotification("Choisis un type d’annonce.");
      return;
    }
    showStep(2);
    return;
  }

  // Étape 2 → adresse / géoloc
 if (state.step === 2) {
  if (!(Number.isFinite(state.lat) && Number.isFinite(state.lng))) {
    showCarteNotification("Indique une adresse ou utilise ta position.");
    return;
  }
  showStep(3);
  return;
}

  // Étape 3 → une question à la fois
  // On synchronise l'état depuis les inputs visibles
  if(state.type === "Offre d'emploi"){
    state.profession = document.getElementById('ms-profession').value.trim();
    state.struct     = document.getElementById('ms-struct').value.trim();
    state.desc       = document.getElementById('ms-desc').value.trim();
    state.photos     = document.getElementById('ms-photos').value.trim();
    state.email      = document.getElementById('ms-email').value.trim();
    state.contact    = document.getElementById('ms-contact').value.trim();
  } else if(state.type === "Location"){
    state.descLoc    = document.getElementById('ms-desc-loc').value.trim();
    state.photosLoc  = document.getElementById('ms-photos-loc').value.trim();
    state.emailLoc   = document.getElementById('ms-email-loc').value.trim();
    state.contactLoc = document.getElementById('ms-contact-loc').value.trim();
  } else { // Candidature
    state.candName   = document.getElementById('ms-cand-name').value.trim();
    state.candProf   = document.getElementById('ms-cand-prof').value.trim();
    state.candDispo  = document.getElementById('ms-cand-dispo').value.trim();
    state.candZone   = document.getElementById('ms-cand-zone').value.trim();
    state.candDesc   = document.getElementById('ms-cand-desc').value.trim();
    state.candEmail  = document.getElementById('ms-cand-email').value.trim();
    state.candTel    = document.getElementById('ms-cand-tel').value.trim();
  }

  // Champ courant de la séquence
  const id = state._seq[state._idx];

  // Validation “mini” si requis (simplement non vide)
  if(id && REQUIRED.has(id)){
    const el = document.getElementById(id);
    const input = el && el.querySelector('input, select, textarea');
    const val = input ? (input.value || '').trim() : 'ok';
    if(!val){
      showCarteNotification("Merci de compléter ce champ.");
      return;
    }
  }

  // Si plus de questions → soumettre
  if(!id){
    submitStep3();
    return;
  }

  // Sinon on passe au champ suivant
  gotoNextField();
}

  // Affiche la feuille dès que l’utilisateur tape dans la recherche (optionnel)
  // document.getElementById('rechercheCommune')?.addEventListener('focus', ()=> isMobile && openSheet());
})();
</script>
  <script>
(function positionPublishBtn(){
  const btn = document.getElementById('mobile-publish-btn');
  const footer = document.getElementById('footer-bar');
  if(!btn || !footer) return;
  function update(){
    const h = footer.getBoundingClientRect().height || 70;
    btn.style.bottom = (h + 72) + 'px';
  }
  update();
  window.addEventListener('resize', update);
  new ResizeObserver(update).observe(footer);
})();
</script>

<!-- ❌ EN PROD: supprime ce bypass reCAPTCHA -->
<!-- Si tu veux garder un mode dev, isole-le derrière un flag "DEBUG" -->
<script>
// 🔴 BYPASS reCAPTCHA global (DEV SEULEMENT)
window.getRecaptchaResponse = function(){ return "DISABLED_TOKEN"; };
window.grecaptcha = window.grecaptcha || {
  render(){}, reset(){}, getResponse(){ return "DISABLED_TOKEN"; }
};

// Force un token sur tous les formulaires qui l'attendent
document.addEventListener('submit', (e) => {
  const f = e.target;
  if (!f) return;
  if (f.id === 'offreForm' || f.id === 'locationForm' || f.id === 'candidatForm') {
    if (!f.dataset) f.dataset = {};
    if (!f.dataset.captcha) f.dataset.captcha = 'DISABLED_TOKEN';
  }
}, true);
</script>
</body>
</html>
<!-- mini commit pour forcer le déploiement -->
