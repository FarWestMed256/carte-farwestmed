<!DOCTYPE html>
<html>
<head>
  <title>Carte FarwestMed</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/basiclightbox@5.0.4/dist/basicLightbox.min.css">
  <script src="https://cdn.jsdelivr.net/npm/basiclightbox@5.0.4/dist/basicLightbox.min.js"></script>
  <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
  <style>
    #map { height: 90vh; width: 100vw; }
    body { margin:0; }
    .photo-gallery img {max-width:140px;max-height:100px;margin:3px;border-radius:8px; cursor:pointer;}
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const API_URL = "https://api.sheetbest.com/sheets/dceb24fc-eba5-4fea-b220-c882b838e643";

    function showLightbox(url) {
      basicLightbox.create(`<img src="${url}" style="max-width:90vw;max-height:90vh;">`).show();
    }
    window.showLightbox = showLightbox;

    // Formulaire de candidature (postuler)
    function openPostulerForm(email, contact, marker) {
      var popupForm = `
        <b>Postuler à cette offre</b><br>
        Votre nom :<br><input type="text" id="candidatNom"><br>
        Votre email :<br><input type="email" id="candidatEmail"><br>
        Message :<br><textarea id="candidatMsg"></textarea><br>
        <button type="button" id="sendCandidature">Envoyer</button>
        <button type="button" id="cancelCandidature">Annuler</button>
      `;
      marker.setPopupContent(popupForm);

      setTimeout(function() {
        document.getElementById('cancelCandidature').onclick = function() {
          marker.closePopup();
        };
        document.getElementById('sendCandidature').onclick = function() {
          // Ici, tu ajouteras la logique d'email automatique à la prochaine étape
          alert("Merci pour votre candidature ! (Le mail sera envoyé automatiquement lors de la prochaine étape)");
          marker.closePopup();
        };
      }, 200);
    }

    function chargerOffres() {
      fetch(API_URL)
        .then(resp => resp.json())
        .then(data => {
          data.forEach(function(offre) {
            if (!offre.Latitude || !offre.Longitude) return;
            let gallery = "";
            if (offre["Photos"]) {
              let urls = offre["Photos"].split(",");
              gallery = '<div class="photo-gallery">' +
                urls.map(u => u.trim() ? `<img src="${u.trim()}" alt="photo" onclick="window.showLightbox('${u.trim()}')">` : "").join("") +
                '</div>';
            }
            // Contenu de la popup de l'offre
            var popupHtml =
              `<b>${offre["Titre de l’offre"] || ''}</b><br>
              ${offre["Nom de la struct"] || ''}<br>
              ${offre["Adresse"] || ''}<br>
              ${offre["Description"] || ''}<br>
              ${gallery}
              <b>Contact :</b> ${offre["Contact"] || ''}<br>
              ${offre["Adresse Email"] ? `<b>Email :</b> ${offre["Adresse Email"]}<br>` : ""}
              <button type="button" class="btn-postuler" 
                data-email="${offre["Adresse Email"] || ''}" 
                data-contact="${offre["Contact"] || ''}">Postuler à cette offre</button>
              `;

            var marker = L.marker([offre.Latitude, offre.Longitude]).addTo(map).bindPopup(popupHtml);

            marker.on("popupopen", function() {
              var btn = document.querySelector(".btn-postuler");
              if(btn) {
                btn.onclick = function() {
                  openPostulerForm(btn.getAttribute("data-email"), btn.getAttribute("data-contact"), marker);
                }
              }
            });
          });
        });
    }

    var map = L.map('map').setView([46.7, 2.5], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);
    chargerOffres();

    map.on('click', function(e) {
      var popupContent = `
        <form id="offreForm">
          <b>Ajouter une offre</b><br>
          Titre de l’offre :<br><input type="text" name="titre"><br>
          Nom de la structure :<br><input type="text" name="structure"><br>
          Adresse :<br><input type="text" name="adresse"><br>
          Description :<br><textarea name="description"></textarea><br>
          Adresse Email (pour recevoir une notification) :<br>
          <input type="email" name="adresseEmail"><br>
          Contact :<br><input type="text" name="contact"><br>
          Photos :<br>
          <input type="text" id="photoURL" name="photos" placeholder="Lien(s) photo..." readonly style="width:70%;"> 
          <button type="button" id="cloudinaryBtn">Uploader des photos</button><br>
          <small>Pour plusieurs photos, sélectionnez-les toutes en une seule fois dans la boîte de dialogue d’upload.<br>
          Tous les champs sont optionnels sauf le contact ou l’email, pour qu’on puisse vous joindre !</small><br>
          <input type="hidden" name="lat" value="`+e.latlng.lat+`">
          <input type="hidden" name="lng" value="`+e.latlng.lng+`">
          <button type="submit">Publier</button>
        </form>
      `;
      var popup = L.popup()
        .setLatLng(e.latlng)
        .setContent(popupContent)
        .openOn(map);

      setTimeout(function() {
        var cloudName = 'damdqxu7t';
        var uploadBtn = document.getElementById('cloudinaryBtn');
        var urlField = document.getElementById('photoURL');
        if (uploadBtn) {
          uploadBtn.onclick = function() {
            cloudinary.openUploadWidget(
              {
                cloudName: cloudName,
                uploadPreset: 'fwmed_unsigned',
                sources: ['local', 'url', 'camera'],
                multiple: true,
                folder: 'offres-farwestmed',
                cropping: false,
                resourceType: 'image',
                maxFileSize: 10485760 // 10MB
              },
              function(error, result) {
                if (!error && result && result.event === "success") {
                  let urls = urlField.value ? urlField.value.split(",") : [];
                  if (result.info.files && Array.isArray(result.info.files)) {
                    urls = urls.concat(result.info.files.map(f => f.uploadInfo.secure_url));
                  } else if (result.info.secure_url) {
                    urls.push(result.info.secure_url);
                  }
                  urlField.value = urls.join(",");
                }
              }
            );
          }
        }
      }, 400);

      document.getElementById('offreForm').onsubmit = function(ev){
        ev.preventDefault();
        var form = ev.target;
        var data = {
          "Titre de l’offre": form.titre.value,
          "Nom de la struct": form.structure.value,
          "Adresse": form.adresse.value,
          "Latitude": form.lat.value,
          "Longitude": form.lng.value,
          "Description": form.description.value,
          "Adresse Email": form.adresseEmail.value,
          "Contact": form.contact.value,
          "Photos": form.photos.value,
          "Statut": "Publiée"
        };

        // Si ni contact ni email, on refuse la soumission
        if (!(form.contact.value || form.adresseEmail.value)) {
          alert("Veuillez renseigner au moins un moyen de contact (email ou téléphone).");
          return false;
        }

        fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        })
        .then(response => {
          if (response.ok) {
            let gallery = "";
            if (form.photos.value) {
              let urls = form.photos.value.split(",");
              gallery = '<div class="photo-gallery">' +
                urls.map(u => u.trim() ? `<img src="${u.trim()}" alt="photo" onclick="window.showLightbox('${u.trim()}')">` : "").join("") +
                '</div>';
            }
            L.marker([form.lat.value, form.lng.value])
              .addTo(map)
              .bindPopup(
                `<b>${form.titre.value}</b><br>
                ${form.structure.value}<br>
                ${form.adresse.value}<br>
                ${form.description.value}<br>
                ${gallery}
                <b>Contact :</b> ${form.contact.value}<br>
                ${form.adresseEmail.value ? `<b>Email :</b> ${form.adresseEmail.value}<br>` : ""}
                <button type="button" class="btn-postuler" data-email="${form.adresseEmail.value}" data-contact="${form.contact.value}">Postuler à cette offre</button>
                `
              );
            map.closePopup();
            alert("Offre ajoutée !");
          } else {
            alert("Erreur lors de l'ajout de l'offre");
          }
        });
      };
    });
  </script>
</body>
</html>
