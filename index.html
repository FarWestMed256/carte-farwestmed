<!DOCTYPE html>
<html>
<head>
  <title>Carte FarwestMed</title>
  <meta charset="utf-8" />
<meta http-equiv="Content-Security-Policy"
      content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net https://www.google.com https://www.gstatic.com https://widget.cloudinary.com https://upload-widget.cloudinary.com;
        style-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net https://widget.cloudinary.com;
        img-src 'self' data: https://cdn.jsdelivr.net https://res.cloudinary.com https://unpkg.com https://lh3.googleusercontent.com https://a.tile.openstreetmap.org https://b.tile.openstreetmap.org https://c.tile.openstreetmap.org https://raw.githubusercontent.com;
        frame-src https://www.google.com https://widget.cloudinary.com https://upload-widget.cloudinary.com;
        connect-src 'self' https://api.sheetbest.com https://app.nocodb.com https://api-adresse.data.gouv.fr https://res.cloudinary.com https://widget.cloudinary.com https://upload-widget.cloudinary.com https://www.google.com https://www.gstatic.com https://raw.githubusercontent.com;
        font-src 'self' https://cdn.jsdelivr.net;
        object-src 'none';
        base-uri 'self';
        form-action 'self';
      ">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/basiclightbox@5.0.4/dist/basicLightbox.min.css">
  <script src="https://cdn.jsdelivr.net/npm/basiclightbox@5.0.4/dist/basicLightbox.min.js"></script>
  <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
  <style>
    body { 
  margin: 0; 
  position: relative; 
}
    #map { height: 90vh; width: 100vw; }
    .photo-gallery img {max-width:140px;max-height:100px;margin:3px;border-radius:8px; cursor:pointer;}
    .btn-postuler {
      font-size: 1.1em;
      background: #f9d875;
      color: #4b3c10;
      border: none;
      padding: 8px 20px;
      border-radius: 10px;
      margin: 8px 0;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 6px #ddd;
      transition: background 0.15s;
      display: inline-block;
    }
    .btn-postuler:hover {
      background: #ffe49c;
    }
    #autocomplete-list {
  background: #292929;
  color: #fff;
  border-radius: 0 0 10px 10px;
  box-shadow: 0 4px 16px #0003;
  max-height: 280px;
  overflow-y: auto;
  position: absolute;
  z-index: 1200;
  width: 320px;
  font-size: 1em;
  padding: 0;
  margin: 0;
}
.autocomplete-suggestion {
  padding: 8px 14px;
  cursor: pointer;
  border-bottom: 1px solid #3334;
  user-select: none;
  transition: background 0.12s;
}
.autocomplete-suggestion:last-child { border-bottom: none; }
.autocomplete-suggestion:hover, .autocomplete-suggestion.active {
  background: #ffe49c;
  color: #333;
}
.autocomplete-highlight {
  background: #ffe49c;
  color: #222;
  font-weight: bold;
  padding: 0 2px;
  border-radius: 2px;
}
    .leaflet-control-layers {
      margin-top: 90px !important;
      margin-left: 10px !important;
    }
    #sidebar-mode-emploi {
  position: fixed;
  top: 0; 
  right: 0;
  height: 100vh;
  width: 0;
  max-width: 440px;
  min-width: 0;
  background: rgba(255,251,231,0.89);
  box-shadow: -4px 0 28px #3332;
  z-index: 4000;
  overflow: hidden;
  transition: width 0.33s cubic-bezier(.83,.1,.5,1.4), min-width 0.33s;
  border-left: 2px solid #ffe49c;
  backdrop-filter: blur(2px);
}
    #sidebar-mode-emploi.open {
  box-shadow: -4px 0 28px #3332;
  /* D√©cale la sidebar de la largeur du bouton (48px) pour ne pas recouvrir le bouton */
  right: 0;
}
#sidebar-mode-emploi.closed {
  right: -30vw; /* ou -80vw sur mobile si tu veux la faire sortir totalement */
}

#sidebar-mode-emploi.open {
  width: 30vw;
  min-width: 340px;
  max-width: 440px;
}
@media (max-width: 900px) {
  #sidebar-mode-emploi.open {
    width: 80vw;
    min-width: 0;
    max-width: 96vw;
  }
}

.sidebar-toggle {
  position: fixed;
  top: 50%;
  left: 10px;
  transform: translateY(-50%);
  width: 48px;
  height: 64px;
  background: linear-gradient(90deg, #ffe97a 80%, #f6f0cf 100%);
  color: #9a8700;
  border: none;
  box-shadow: 1px 1px 18px #b9a22b25;
  border-radius: 0 18px 18px 0;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  z-index: 5000;
  transition: background 0.18s, color 0.18s, box-shadow 0.2s, left 0.3s;
  font-size: 2.2em;
  outline: none;
  border: 2px solid #efd600a6;
}
.sidebar-toggle:hover {
  background: linear-gradient(90deg, #fff8cf 85%, #fffbe7 100%);
  color: #b9a22b;
  box-shadow: 1px 4px 22px #ffe97a55;
}
#toggle-arrow { transition: transform 0.2s; }
@media (max-width: 900px) {
  .sidebar-toggle { width: 40px; height: 52px; font-size: 2em; }
}
#sidebar-mode-emploi.closed .sidebar-toggle {
  right: 0;
}
.sidebar-toggle:hover {
  background: #ffefbc;
  transform: translateY(-50%) scale(1.07);
  box-shadow: -2px 4px 18px #c7b24866;
}

.sidebar-content {
  padding: 24px 18px 34px 18px;   /* Mets plus de padding en bas pour √©viter que le bouton cache la fin ! */
  font-size: 1.07em;
  overflow-y: auto;
  height: 100vh;                  /* Ajoute height pour assurer le scroll total */
  max-height: 100vh;
  box-sizing: border-box;
  scrollbar-width: thin;
}
#sidebar-mode-emploi.closed { width: 0; min-width: 0;}
#sidebar-mode-emploi.closed .sidebar-content { display: none;}
#toggle-arrow { transition: transform 0.2s; }
#sidebar-mode-emploi.open #toggle-arrow { transform: rotate(180deg); }
    /* Pour forcer les popups devant tout le reste */
.leaflet-popup,
.leaflet-popup-pane,
.leaflet-container .leaflet-popup,
.leaflet-container .leaflet-popup-content-wrapper,
.leaflet-container .leaflet-popup-content {
  z-index: 99999 !important;
}

/* Place les contr√¥les et la barre de recherche en-dessous du popup */
.leaflet-top, .leaflet-bottom, .leaflet-control,
#rechercheCommune {
  z-index: 9000 !important;
  /* Tu peux aussi ajouter une transition pour l‚Äôopacit√© si tu veux la faire varier */
  transition: opacity 0.15s;
}
#autocomplete-list {
  z-index: 1200 !important;
}
.sidebar-toggle {
  z-index: 8900 !important;
}
  /* ======= Barre de recherche sur la carte ======= */
    #recherche-bar {
  position: fixed;
  left: 18px;
  bottom: 18px;
  width: auto;
  min-width: 320px;
  z-index: 9000;
  display: flex;
  pointer-events: none;
}
#rechercheCommune, #autocomplete-list {
  pointer-events: auto;
}
#rechercheCommune {
  padding: 10px 18px;
  width: 320px;
  border-radius: 10px;
  border: 1.5px solid #e3e3e3;
  font-size: 1.11em;
  box-shadow: 0 2px 14px #f7e46a18;
  background: #fff;
}
#autocomplete-list {
  position: absolute;
  left: 0;
  right: auto;
  bottom: 48px;
  top: auto;
  z-index: 9001;
  width: 340px;
}
  </style>
</head>
  <!-- BARRE DE RECHERCHE EN-T√äTE -->
<body>
<div id="map"></div>
<div id="recherche-bar">
  <input
  id="rechercheCommune"
  type="text"
  autocomplete="off"
  placeholder="Rechercher une adresse"
>
  <div id="autocomplete-list"></div>
</div>
<!-- Ici la carte s‚Äôarr√™te -->
   <button class="sidebar-toggle" id="sidebar-toggle-btn" onclick="toggleSidebar()" aria-label="Afficher/masquer le mode d'emploi">
  <span id="toggle-arrow">&#9664;</span>
</button>
  <div id="sidebar-mode-emploi" class="sidebar open">
  <div class="sidebar-content">
    <h3>üó∫Ô∏è Mode d‚Äôemploi de la carte</h3>
    <ul style="list-style:none;padding:0;">
      <li style="margin-bottom:14px;">
  <b>üóÇÔ∏è Choix des zones :</b><br>
  <span>
    Activez/d√©sactivez les calques pour afficher‚ÄØ:<br>
    <span style="margin-left:1em;">
      <img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png" 
           style="height:27px;vertical-align:middle;margin-right:4px;">
      <b>Communes ZIP</b> :
      Zones d‚ÄôIntervention Prioritaire (prime <b>50‚ÄØ000‚ÄØ‚Ç¨</b> √† l‚Äôinstallation, exon√©rations, aides ARS).
    </span><br>
    <span style="margin-left:1em;">
      <img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png" 
           style="height:27px;vertical-align:middle;margin-right:4px;">
      <b>Communes ZRR</b> :
      Zones de Revitalisation Rurale (primes fiscales, exon√©rations d‚Äôimp√¥ts, aides cumulables avec ZIP).
    </span><br>
    <span style="margin-left:1em;">
      <img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png" 
           style="height:27px;vertical-align:middle;margin-right:4px;">
      <b>Communes ZAC</b> :
      Zones d‚ÄôAction Compl√©mentaire (autres dispositifs selon r√©gion).
    </span><br>
    <span style="margin-left:1em;">
  <span style="font-size:1.32em;vertical-align:middle;margin-right:4px;">‚≠ê</span>
  <b>Communes GOLD</b> (<b>ZIP + ZRR</b>) :
  cumulent tous les avantages‚ÄØ!
</span>
  </span>
</li>
      <li style="margin-bottom:14px;">
        <b>üìç Parcourir la carte :</b><br>
        <span>Zoomez, cliquez sur un marqueur pour voir le d√©tail des offres, ou explorez librement la France m√©dicale.</span>
      </li>
      <li style="margin-bottom:14px;">
        <b>üìù D√©poser une offre ou un cabinet :</b><br>
        <span>
          <span style="margin-left:1em;">‚Ä¢ Cliquez n‚Äôimporte o√π sur la carte pour d√©poser‚ÄØ:</span><br>
          <span style="margin-left:2em;">- <b>Une offre d‚Äôemploi</b> (<span style="color:#2c91ed;">üìÑ</span>)</span><br>
          <span style="margin-left:2em;">- <b>Un cabinet/bureau √† louer</b> (<span style="color:#ffaa00;">üè¢</span>)</span>
        </span>
      </li>
      <li style="margin-bottom:14px;">
        <b>üí° R√©pondre √† une offre :</b><br>
        <span>
          <span style="margin-left:1em;">‚Ä¢ Cliquez sur une annonce pour postuler ou signaler votre int√©r√™t en un clic.</span>
        </span>
      </li>
      <li>
        <span style="color:#888;font-size:0.98em;">
          üì£ <b>Contactez-nous :</b><br>
          <span style="color:#333;">farwestmed013@gmail.com</span>
        </span>
      </li>
    </ul>
  </div>
</div>
  <div id="footer-infos"
  style="
    position:fixed;
    left:50%;
    bottom:15px;
    transform:translateX(-50%);
    background:rgba(245, 245, 245, 0.95);
    color:#333;
    font-size:1em;
    padding:10px 24px;
    border-radius:16px;
    box-shadow:0 2px 18px #0002;
    z-index:3200;
    font-weight:500;
    letter-spacing:0.04em;
    opacity:0.98;">
  Donn√©es de zonages √† jour au 1er ao√ªt 2025
</div>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script>
    function canSubmit(formKey, limit = 5, delayMin = 60) {
  const now = Date.now();
  let logs = [];
  try {
    logs = JSON.parse(localStorage.getItem(formKey) || "[]");
  } catch (e) { logs = []; }
  // Garde seulement les entr√©es des X derni√®res minutes
  const recent = logs.filter(t => now - t < delayMin * 60 * 1000);
  if (recent.length >= limit) return false;
  recent.push(now);
  localStorage.setItem(formKey, JSON.stringify(recent));
  return true;
}
    function showCarteNotification(msg, timeout = 2500) {
  let notif = document.createElement('div');
  notif.textContent = msg;
  notif.style = `
    position:fixed;
    top:40px; left:50%;
    transform:translateX(-50%);
    background:#222;
    color:#fff;
    font-size:1.15em;
    padding:13px 30px;
    border-radius:12px;
    box-shadow:0 8px 22px #0002;
    z-index:4000;
    opacity:0.98;
    pointer-events:none;
    transition:opacity 0.2s;
  `;
  document.body.appendChild(notif);
  setTimeout(() => { notif.style.opacity = '0'; }, timeout-350);
  setTimeout(() => { notif.remove(); }, timeout);
}
    function cleanNom(str) {
  return str
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .toLowerCase()
    .replace(/[\s'-]/g,"");
}
    function forceLineBreaksAfterDot(str) {
  if (!str) return '';
  // Ajoute <br> apr√®s chaque point suivi d'un espace (optionnel), SAUF si :
  // - pr√©c√©d√© d'un chiffre (num√©ro)
  // - pr√©c√©d√© d'un @ (mail)
  // - suivi de com/fr/org/net/gov/edu (mail/url)
  return str.replace(/([^0-9@])\. ?(?!((com|fr|org|net|gov|edu)\b))/gi, '$1.<br>');
}
    function addLineBreaksBeforeEmoji(str) {
  if (!str) return '';
  return str.replace(
    /([^\n])([\u{1F300}-\u{1FAFF}\u{1F1E6}-\u{1F1FF}\u2600-\u27BF\u{1F900}-\u{1F9FF}\u231A-\u231B\u23E9-\u23EC\u23F0-\u23F4\u25FD-\u25FE\u2614-\u2615\u2648-\u2653\u267F\u2693\u26A1\u26AA-\u26AB\u26BD-\u26BE\u26C4-\u26C5\u26CE\u26D4\u26EA\u26F2-\u26FA\u26FD\u2705\u270A-\u270B\u2728\u274C\u274E\u2753-\u2755\u2757\u2795-\u2797\u27B0\u27BF\u2934-\u2935\u2B05-\u2B07\u2B1B-\u2B1C\u2B50\u2B55\u3030\u303D\u3297\u3299])/gu,
    function(match, prev, emoji) {
      if (prev === '\n' || prev === '<br>') return prev + emoji;
      return prev + '<br>' + emoji;
    }
  );
}
    function nl2br(str) {
  if (!str) return '';
  return str.replace(/(?:\r\n|\r|\n)/g, '<br>');
}
    // Mapping type d'offre ‚Üí URL d‚Äôic√¥ne
const iconesTypeOffre = {
  "M√©decin g√©n√©raliste": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/doctor.svg",
  "M√©decin sp√©cialiste": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/doctor.svg",
  "Kin√©sith√©rapeute": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/physiotherapist.svg",
  "Sage-femme": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/midwife.svg",
  "Infirmier(e) dipl√¥m√©(e) d‚Äô√âtat (IDE)": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/nurse.svg",
  "Infirmier(e) Asal√©e": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/nurse.svg",
  "Orthophoniste": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/speech-therapist.svg",
  "Orthoptiste": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/optometrist.svg",
  "Psychologue": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/psychologist.svg",
  "Ergoth√©rapeute": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/physiotherapist.svg",
  "P√©dicure-podologue": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/foot-doctor.svg",
  "Di√©t√©ticien(ne)": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/dietitian.svg",
  "Psychomotricien(ne)": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/psychologist.svg",
  "Ost√©opathe": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/physiotherapist.svg",
  "Chirurgien-dentiste": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/dentist.svg",
  "Ophtalmologiste": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/ophthalmologist.svg",
  "Pharmacien(ne)": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/pharmacist.svg",
  "Secr√©taire m√©dical(e)": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/receptionist.svg",
  "Assistant(e) m√©dical(e)": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/medical-assistant.svg",
  "Aide-soignant(e)": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/nurse.svg",
  "Autre professionnel de sant√©": "https://cdn.jsdelivr.net/gh/steven2358/medical-icons/svg/doctor.svg"
};
    // URLs d'API Sheet.best pour chaque sheet
    const API_OFFRES = "https://api.sheetbest.com/sheets/c6bdfcfd-13c2-4f7e-8b26-4fd3f0be5068";
    const API_CANDIDATURES = "https://api.sheetbest.com/sheets/fea9ad93-6045-46ef-af9d-9ed93a9f5a4c";
const API_LOCATIONS = "https://app.nocodb.com/api/v2/tables/ml3ezzqhxcfuhpi/records";
const API_TOKEN = "zuBtJi0p7vALQo2W_HTWzvaYRxyyQKOhRaLsrNU4";
    function showLightbox(url) {
      basicLightbox.create('<img src="' + url + '" style="max-width:90vw;max-height:90vh;">').show();
    }
    window.showLightbox = showLightbox;

function openPostulerForm(email, contact, marker, offreTitle) {
  setTimeout(function() {
    var popupForm =
      '<b>Postuler √† cette offre</b><br>'+
      'Votre nom :<br><input type="text" id="candidatNom"><br>'+
      'Votre email :<br><input type="email" id="candidatEmail"><br>'+
      'Message :<br><textarea id="candidatMsg"></textarea><br>'+
      '<div class="g-recaptcha" data-sitekey="6LcL9ZYrAAAAACVHhVg6o6Xyj0_y2uR5X0n-URGb"></div>'+
      '<button type="button" id="sendCandidature" ...>Envoyer</button>'+
      '<button type="button" id="cancelCandidature" style="margin-left:8px;">Annuler</button>';
    marker.setPopupContent(popupForm);

    setTimeout(function() {
      var btnCancel = document.getElementById('cancelCandidature');
      if (btnCancel) btnCancel.onclick = function() {
        window.map.closePopup();
        if (window.grecaptcha) grecaptcha.reset();
      };

      // AJOUTE CE BLOC :
      if (window.grecaptcha && document.querySelector('#candidatNom') && document.querySelector('.g-recaptcha')) {
        grecaptcha.render(document.querySelector('.g-recaptcha'));
      }
    }, 200);
  }, 100);
}

    function chargerOffres() {
      fetch(API_OFFRES)
        .then(resp => resp.json())
        .then(data => {
          data.forEach(function(offre, idx) {
            if ((offre.Statut || "").toLowerCase() !== "publi√©e") return;
            if (!offre.Latitude || !offre.Longitude) return;
            let gallery = "";
            if (offre["Photos"]) {
              let urls = offre["Photos"].split(",");
              gallery = '<div class="photo-gallery">' +
                urls.map(u => u.trim() ? '<img src="'+u.trim()+'" alt="photo" onclick="window.showLightbox(\''+u.trim()+'\')">' : "").join("") +
                '</div>';
            }
            var postulerId = `btn-postuler-${idx}`;
            var popupHtml =
              `<b>${offre["Titre de l‚Äôoffre"] || ''}</b><br>
              ${offre["Nom de la struct"] || ''}<br>
              ${offre["Adresse"] || ''}<br>
${addLineBreaksBeforeEmoji(forceLineBreaksAfterDot(nl2br(offre["Description"] || '')))}<br>
${gallery}
              <b>Contact :</b> ${offre["Contact"] || ''}<br>
              ${offre["Adresse Email"] ? `<b>Email :</b> ${offre["Adresse Email"]}<br>` : ""}
              <button type="button" class="btn-postuler" id="${postulerId}"
                data-email="${offre["Adresse Email"] || ''}" 
                data-contact="${offre["Contact"] || ''}">Postuler √† cette offre</button>
              `;

            const emojisTypeOffre = {
  "M√©decin g√©n√©raliste": "ü©∫",
  "M√©decin sp√©cialiste": "ü©ª",
  "Kin√©sith√©rapeute": "üí™",
  "Sage-femme": "ü§±",
  "Infirmier(e) dipl√¥m√©(e) d‚Äô√âtat (IDE)": "üíâ",
  "Infirmier(e) Asal√©e": "üíâ",
  "Orthophoniste": "üó£Ô∏è",
  "Orthoptiste": "üëÅÔ∏è",
  "Psychologue": "üß†",
  "Ergoth√©rapeute": "üñêÔ∏è",
  "P√©dicure-podologue": "ü¶∂",
  "Di√©t√©ticien(ne)": "ü•ó",
  "Psychomotricien(ne)": "ü§∏",
  "Ost√©opathe": "üëê",
  "Chirurgien-dentiste": "ü¶∑",
  "Ophtalmologiste": "üëì",
  "Pharmacien(ne)": "üíä",
  "Secr√©taire m√©dical(e)": "üóÇÔ∏è",
  "Assistant(e) m√©dical(e)": "üë©‚Äçüíº",
  "Autre professionnel de sant√©": "‚öïÔ∏è",
  "Offre d'emploi pluridisciplinaire": "üë©üèª‚Äç‚öïÔ∏èüë®üèª‚Äç‚öïÔ∏è "  // ou choisis l'emoji qui te pla√Æt le plus
};
var typeOffre = (offre["Titre de l‚Äôoffre"] || "").trim();
            if (typeOffre === "Aide-soignant(e)") {
  typeOffre = "Autre professionnel de sant√©";
} else if (typeOffre === "Autre professionnel de sant√©") {
  typeOffre = "Offre d'emploi pluridisciplinaire";
}
var emoji = emojisTypeOffre[typeOffre] || "‚ùì";

// Cr√©ation d‚Äôun DivIcon Leaflet (affiche l‚Äô√©moji dans un rond blanc)
var customIcon = L.divIcon({
  html: `<div style="
    font-size:2.2em;
    width:46px;height:46px;
    border-radius:50%;
    background:#fff;
    border:2px solid #eee;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow:0 1px 5px #0002;
  ">${emoji}</div>`,
  className: '',   // pas de classe personnalis√©e (on utilise le style inline)
  iconSize: [46,46],
  iconAnchor: [23,46],
  popupAnchor: [0,-46]
});
var marker = L.marker([offre.Latitude, offre.Longitude], {icon: customIcon}).addTo(map).bindPopup(popupHtml);

            marker.on("popupopen", function() {
              var btn = document.getElementById(postulerId);
              if(btn) {
                btn.onclick = function() {
                  openPostulerForm(
                    btn.getAttribute("data-email"), 
                    btn.getAttribute("data-contact"), 
                    marker, 
                    offre["Titre de l‚Äôoffre"] || ""
                  );
                }
              }
            });
          });
        });
    }

    var map = L.map('map').setView([46.7, 2.5], 6);
window.onload = function() {
  document.getElementById('rechercheCommune').addEventListener('mousedown', function(e) {
    e.stopPropagation();
  });
  document.getElementById('autocomplete-list').addEventListener('mousedown', function(e) {
    e.stopPropagation();
  });
};
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '¬© OpenStreetMap contributors'
}).addTo(map);
map.whenReady(function() {
  const urlParams = new URLSearchParams(window.location.search);
  const lat = parseFloat(urlParams.get('lat'));
  const lng = parseFloat(urlParams.get('lng'));
  const zoom = parseInt(urlParams.get('zoom')) || 15; // Ajout√© !

  if (!isNaN(lat) && !isNaN(lng)) {
    setTimeout(function() {
      map.setView([lat, lng], zoom, { animate: true });
      const m = L.marker([lat, lng], {
        icon: L.icon({
          iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
          shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        })
      }).addTo(map)
      .bindPopup("üëâ Offre ici").openPopup();
      setTimeout(() => map.removeLayer(m), 12000);
    }, 500);
  }
});

// D√©calage du centre vers la gauche (pour sidebar √† droite)
map.whenReady(function() {
  const urlParams = new URLSearchParams(window.location.search);
  const lat = parseFloat(urlParams.get('lat'));
  const lng = parseFloat(urlParams.get('lng'));
  if (isNaN(lat) || isNaN(lng)) {
    setTimeout(function() {
      var size = map.getSize();
      map.panBy([size.x * 0.18, 0], { animate: false });  // 30% de la largeur vers la droite (d√©cale le centre √† gauche)
    }, 400); // petit d√©lai pour √™tre s√ªr que tout est charg√©
  }
});
    chargerOffres();
    chargerLocationsExistantes();
function chargerLocationsExistantes() {
  fetch(API_LOCATIONS, {
    method: "GET",
    headers: {
      "xc-token": API_TOKEN
    }
  })
  .then(resp => resp.json())
  .then(data => {
    (data.list || data).forEach(function(loc) {
      if (loc.Statut && loc.Statut.toLowerCase() === "archiv√©e") return;
      if (!loc.Latitude || !loc.Longitude) return;
      let gallery = "";
      if (loc.Photos) {
        let urls = loc.Photos.split(",");
        gallery = '<div class="photo-gallery">' +
          urls.map(u => u.trim() ? '<img src="'+u.trim()+'" alt="photo" onclick="window.showLightbox(\''+u.trim()+'\')">' : "").join("") +
          '</div>';
      }
      var locationIcon = L.divIcon({
        html: `<div style="
          font-size:2em;
          width:40px;height:40px;
          border-radius:50%;
          background:#fffbe7;
          border:2px solid #ffe49c;
          display:flex;
          align-items:center;
          justify-content:center;
          box-shadow:0 1px 5px #ffd70077;
        ">üè¢</div>`,
        className: '',
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40]
      });
    L.marker([parseFloat(loc.Latitude), parseFloat(loc.Longitude)], {icon: locationIcon})
  .addTo(map)
  .bindPopup(
    `<b>Cabinet ou bureau √† louer</b><br>
    ${loc.Adresse || ""}<br>
   ${addLineBreaksBeforeEmoji(forceLineBreaksAfterDot(nl2br(loc.Description || '')))}<br>
    ${gallery}
    <b>Contact :</b> ${loc.Contact || ""}<br>
    ${loc.Email ? `<b>Email :</b> ${loc.Email}<br>` : ""}
    <button type="button" class="btn-interesse-location"
      data-email="${loc.Email || ""}"
      data-contact="${loc.Contact || ""}"
      data-adresse="${loc.Adresse || ""}"
      data-description="${loc.Description || ""}"
      style="background:#B6E3FF;color:#095b89;padding:6px 18px;font-size:1em;border-radius:8px;border:none;cursor:pointer;margin-top:8px;margin-bottom:4px;">
      √áa m'int√©resse&nbsp;!
    </button>`
  );
    });
  });
}
// 1. Cr√©e le layer ZIP
var zipCluster = L.markerClusterGroup().addTo(map);
    var zrrCluster = L.markerClusterGroup().addTo(map);
    var goldCluster = L.markerClusterGroup().addTo(map);
    var zacCluster = L.markerClusterGroup().addTo(map);
// 2. Fonction d'import du CSV ZIP
function importerZIP(csvFile, groupLayer) {
  console.log('importerZIP appel√©e !');
  fetch(csvFile)
    .then(resp => resp.text())
    .then(csvText => {
      Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          console.log('PapaParse termin√©, nb lignes :', results.data.length, results.data[0]);
          results.data.forEach(function(row) {
            var lat = parseFloat(row.Latitude || row.latitude || row.lat);
            var lon = parseFloat(row.Longitude || row.longitude || row.lon);
var nom = row["Nom de la commune"] || row["Commune"] || row["commune"] || row["Nom Commune"] || row["Ville"] || row["Nom"] || row.nom || "Ville ZIP";            if (!isNaN(lat) && !isNaN(lon)) {
  var redIcon = L.icon({
                iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
                shadowSize: [41, 41]
              });
              // Ajoute le marqueur ZIP + infobulle au survol
              let marker = L.marker([lat, lon], {icon: redIcon, title: nom})
  .bindTooltip(nom, {permanent: false, direction: "top"});
groupLayer.addLayer(marker); 
              // Ajoute cette ligne juste apr√®s avoir cr√©√© le marker :
if (!window.markersByName) window.markersByName = {};
window.markersByName[cleanNom(nom)] = marker;
            }
          });
        }
      });
    });
}
    // 3. Importe le calque ZIP (mets le nom r√©el de ton fichier CSV !)
importerZIP('communes_zip_geo.csv', zipCluster);
    function importerZRR(csvFile, groupLayer) {
  fetch(csvFile)
    .then(resp => resp.text())
    .then(csvText => {
      Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          results.data.forEach(function(row) {
            var lat = parseFloat(row.Latitude || row.latitude || row.lat);
            var lon = parseFloat(row.Longitude || row.longitude || row.lon);
            var nom = row["Commune"] || row["commune"] || row["Nom Commune"] || row["Ville"] || row["Nom"] || row.nom || "Ville ZRR";            
            if (!isNaN(lat) && !isNaN(lon)) {
              var greenIcon = L.icon({
                iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
                shadowSize: [41, 41]
              });
              let marker = L.marker([lat, lon], {icon: greenIcon, title: nom})
                .bindTooltip(nom, {permanent: false, direction: "top"});
              groupLayer.addLayer(marker);

              // On peut aussi les r√©f√©rencer dans un autre objet si besoin
              if (!window.zrrMarkersByName) window.zrrMarkersByName = {};
              window.zrrMarkersByName[cleanNom(nom)] = marker;
            }
          });
        }
      });
    });
}
importerZRR('communes_zrr_geo.csv', zrrCluster);

    function importerGOLD(csvFile, groupLayer) {
  fetch(csvFile)
    .then(resp => resp.text())
    .then(csvText => {
      Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          results.data.forEach(function(row) {
            var lat = parseFloat(row.Latitude || row.latitude || row.lat);
            var lon = parseFloat(row.Longitude || row.longitude || row.lon);
            var nom = row["Commune"] || row["Nom de la commune"] || row["commune"] || row.nom || "Commune GOLD";
            if (!isNaN(lat) && !isNaN(lon)) {
              var goldIcon = L.divIcon({
  className: 'gold-div-icon',
  iconSize: [38, 54],
  iconAnchor: [19, 54],
  popupAnchor: [1, -34],
  html: `
    <div style="
      position: relative;
      width: 38px;
      height: 54px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    ">
      <span style="
        font-size: 1.7em;
        color: #ffe066;
        text-shadow: 0 0 10px #ffd700, 0 0 3px #fff;
        position: absolute;
        top: 2px;
        left: 8px;
        z-index: 2;
      ">‚≠ê</span>
      <img src="https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-yellow.png"
        style="
          width: 38px;
          height: 54px;
          filter:
            drop-shadow(0 0 8px #ffd700)
            brightness(1.4)
            saturate(1.5);
        "
      />
    </div>
  `
});
              let marker = L.marker([lat, lon], {icon: goldIcon, title: nom})
                .bindTooltip(nom, {permanent: false, direction: "top"});
              groupLayer.addLayer(marker);
              if (!window.goldMarkersByName) window.goldMarkersByName = {};
              window.goldMarkersByName[cleanNom(nom)] = marker;
            }
          });
        }
      });
    });
}

importerGOLD('https://raw.githubusercontent.com/FarWestMed256/carte-farwestmed/refs/heads/main/communes_gold_geo.csv', goldCluster);
    
   function importerZAC(csvFile, groupLayer) {
     console.log("Appel importerZAC avec le fichier :", csvFile);
  fetch(csvFile)
    .then(resp => resp.text())
    .then(csvText => {
      Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          results.data.forEach(function(row) {
            var lat = parseFloat(row.Latitude);
            var lon = parseFloat(row.Longitude);
            var nom = row.Commune || "Commune ZAC";
            if (!isNaN(lat) && !isNaN(lon)) {
              var blueIcon = L.icon({
                iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
                shadowSize: [41, 41]
              });
              let marker = L.marker([lat, lon], {icon: blueIcon, title: nom})
                .bindTooltip(nom, {permanent: false, direction: "top"});
              groupLayer.addLayer(marker);
              if (!window.zacMarkersByName) window.zacMarkersByName = {};
              window.zacMarkersByName[cleanNom(nom)] = marker;
            }
          });
        }
      });
    });
}

    importerZAC('communes_zac_geoloc.csv', zacCluster);
// Fonction utilitaire pour remplir le datalist
// ------------------- AUTOCOMPLETE CUSTOM ZIP + ADRESSE -------------------
let autocompleteIndex = -1; // pour le survol clavier

document.getElementById('rechercheCommune').addEventListener('input', function(e) {
  const val = cleanNom(this.value.trim());
  const raw = this.value.trim();
  const box = document.getElementById('autocomplete-list');
  let suggestions = [];

  // 1. Ajoute les communes ZIP (ZIP FarWestMed)
  if (window.markersByName) {
    Object.keys(window.markersByName).forEach(function(key) {
      let marker = window.markersByName[key];
      if (marker && marker.options && marker.options.title) {
        if (cleanNom(marker.options.title).indexOf(val) !== -1 || key.indexOf(val) !== -1) {
          suggestions.push(marker.options.title);
        }
      }
    });
  }

  // 2. Ajoute les suggestions adresses API data.gouv
  let apiDone = false;
  const fill = (finalSuggestions) => {
    // Surlignage
    let regex = new RegExp('('+raw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')+')', 'ig');
    box.innerHTML = finalSuggestions.slice(0, 20).map((s, i) => 
      `<div class="autocomplete-suggestion${i===0 ? ' active':''}" tabindex="-1" data-label="${s.replace(/"/g,'&quot;')}">
        ${s.replace(regex, '<span class="autocomplete-highlight">$1</span>')}
      </div>`
    ).join('');
    autocompleteIndex = 0;
  };

  if (raw.length > 2) {
    fetch('https://api-adresse.data.gouv.fr/search/?q=' + encodeURIComponent(raw) + '&limit=20')
      .then(r => r.json())
      .then(json => {
        if (json.features && json.features.length > 0) {
          json.features.forEach(f => {
            if (suggestions.indexOf(f.properties.label) === -1) {
              suggestions.push(f.properties.label);
            }
          });
        }
        fill(suggestions);
      });
  } else {
    fill(suggestions);
  }
});

// 3Ô∏è‚É£ S√©lection √† la souris
document.getElementById('autocomplete-list').addEventListener('mousedown', function(e) {
  if (e.target.classList.contains('autocomplete-suggestion')) {
    document.getElementById('rechercheCommune').value = e.target.dataset.label;
    triggerRechercheCommune(e.target.dataset.label);
    this.innerHTML = "";
  }
});

// 4Ô∏è‚É£ Navigation clavier (fl√®ches + entr√©e)
document.getElementById('rechercheCommune').addEventListener('keydown', function(e) {
  const box = document.getElementById('autocomplete-list');
  let items = Array.from(box.children);
  if (!items.length) return;

  if (e.key === 'ArrowDown') {
    autocompleteIndex = (autocompleteIndex + 1) % items.length;
    items.forEach(el => el.classList.remove('active'));
    items[autocompleteIndex].classList.add('active');
    items[autocompleteIndex].scrollIntoView({block:'nearest'});
    e.preventDefault();
  }
  if (e.key === 'ArrowUp') {
    autocompleteIndex = (autocompleteIndex - 1 + items.length) % items.length;
    items.forEach(el => el.classList.remove('active'));
    items[autocompleteIndex].classList.add('active');
    items[autocompleteIndex].scrollIntoView({block:'nearest'});
    e.preventDefault();
  }
  if (e.key === 'Enter') {
    if (items[autocompleteIndex]) {
      this.value = items[autocompleteIndex].dataset.label;
      triggerRechercheCommune(items[autocompleteIndex].dataset.label);
      box.innerHTML = "";
      e.preventDefault();
    }
  }
  if (e.key === 'Escape') {
    box.innerHTML = "";
  }
});

// 5Ô∏è‚É£ S√©lection logique (ce qui se passe quand on choisit une suggestion)
function triggerRechercheCommune(val) {
  var recherche = val.trim();
  var key = cleanNom(recherche);
  // Recherche ZIP
  var trouve = null;
  Object.keys(window.markersByName).forEach(function(k) {
    var marker = window.markersByName[k];
    if (marker && marker.options && cleanNom(marker.options.title || k) === key) {
      trouve = marker;
    }
  });
  if (trouve) {
    map.setView(trouve.getLatLng(), 13);
    trouve.openPopup();
    return;
  }
  // Sinon API adresse
  fetch('https://api-adresse.data.gouv.fr/search/?q=' + encodeURIComponent(recherche) + '&limit=1')
    .then(r => r.json())
    .then(json => {
      if (json.features && json.features.length > 0) {
        var coords = json.features[0].geometry.coordinates;
        var label = json.features[0].properties.label;
        map.setView([coords[1], coords[0]], 16);
        if (window.chercheMarker) map.removeLayer(window.chercheMarker);
        window.chercheMarker = L.marker([coords[1], coords[0]]).addTo(map).bindPopup(label).openPopup();
      } else {
        alert("Adresse ou commune non trouv√©e.");
      }
    });
}

// Fermer suggestions quand on clique hors du champ
document.addEventListener('mousedown', function(e) {
  if (!document.getElementById('autocomplete-list').contains(e.target) &&
      e.target !== document.getElementById('rechercheCommune')) {
    document.getElementById('autocomplete-list').innerHTML = "";
  }
});
    
// 4. Ajoute le contr√¥le de calque
L.control.layers(null, {
  'Communes ZIP': zipCluster,
  'Communes ZRR': zrrCluster,
  'Communes GOLD: ZIP+ZRR': goldCluster,
  'Communes ZAC': zacCluster
}, { position: 'topleft' }).addTo(map);

    function afficherFormulaireOffre(latlng) {
      var popupContent = 
        `<form id="offreForm">
          <b>Ajouter une offre</b><br>
          <label for="typeOffre"><b>Type d'offre :</b></label><br>
<select id="typeOffre" name="typeOffre" required style="width:100%;padding:6px;border-radius:8px;margin-bottom:8px;">
  <option value="">-- S√©lectionner --</option>
  <option value="M√©decin g√©n√©raliste">M√©decin g√©n√©raliste</option>
  <option value="M√©decin sp√©cialiste">M√©decin sp√©cialiste (sp√©cialit√© √† pr√©ciser)</option>
  <option value="Kin√©sith√©rapeute">Kin√©sith√©rapeute</option>
  <option value="Sage-femme">Sage-femme</option>
  <option value="Infirmier(e) dipl√¥m√©(e) d‚Äô√âtat (IDE)">Infirmier(e) dipl√¥m√©(e) d‚Äô√âtat (IDE)</option>
  <option value="Infirmier(e) Asal√©e">Infirmier(e) Asal√©e</option>
  <option value="Orthophoniste">Orthophoniste</option>
  <option value="Orthoptiste">Orthoptiste</option>
  <option value="Psychologue">Psychologue</option>
  <option value="Ergoth√©rapeute">Ergoth√©rapeute</option>
  <option value="P√©dicure-podologue">P√©dicure-podologue</option>
  <option value="Di√©t√©ticien(ne)">Di√©t√©ticien(ne)</option>
  <option value="Psychomotricien(ne)">Psychomotricien(ne)</option>
  <option value="Ost√©opathe">Ost√©opathe</option>
  <option value="Chirurgien-dentiste">Chirurgien-dentiste</option>
  <option value="Ophtalmologiste">Ophtalmologiste</option>
  <option value="Pharmacien(ne)">Pharmacien(ne)</option>
  <option value="Secr√©taire m√©dical(e)">Secr√©taire m√©dical(e)</option>
  <option value="Assistant(e) m√©dical(e)">Assistant(e) m√©dical(e)</option>
  <option value="Autre professionnel de sant√©">Autre professionnel de sant√©</option>
<option value="Offre d'emploi pluridisciplinaire">Offre d'emploi pluridisciplinaire</option>
</select>
          Nom de la structure :<br><input type="text" name="structure"><br>
          Adresse :<br><input type="text" name="adresse"><br>
          Latitude :<br><input type="text" name="lat" value="${latlng.lat}" readonly><br>
Longitude :<br><input type="text" name="lng" value="${latlng.lng}" readonly><br>
          Description :<br><textarea name="description"></textarea><br>
          Adresse Email (pour recevoir une notification) :<br>
          <input type="email" name="adresseEmail"><br>
          Contact :<br><input type="text" name="contact"><br>
          Photos :<br>
          <input type="text" id="photoURL" name="photos" placeholder="Lien(s) photo..." readonly style="width:70%;"> 
          <button type="button" id="cloudinaryBtn">Uploader des photos</button><br>
          <small>Tous les champs sont optionnels sauf le contact ou l‚Äôemail, pour qu‚Äôon puisse vous joindre !</small><br>
          <div class="g-recaptcha" data-sitekey="6LcL9ZYrAAAAACVHhVg6o6Xyj0_y2uR5X0n-URGb"></div>
          <button type="submit">Publier</button>
        </form>`;
      var popup = L.popup()
        .setLatLng(latlng)
        .setContent(popupContent)
        .openOn(map);

     setTimeout(function() {
  var cloudName = 'damdqxu7t';
  var uploadBtn = document.getElementById('cloudinaryBtn');
  var urlField = document.getElementById('photoURL');
  if (uploadBtn) {
    uploadBtn.onclick = function() {
      cloudinary.openUploadWidget(
        {
          cloudName: cloudName,
          uploadPreset: 'fwmed_unsigned',
          sources: ['local', 'url', 'camera'],
          multiple: true,
          folder: 'offres-farwestmed',
          cropping: false,
          resourceType: 'image',
          maxFileSize: 10485760 // 10MB
        },
        function(error, result) {
          if (!error && result && result.event === "success") {
            let urls = urlField.value ? urlField.value.split(",") : [];
            if (result.info.files && Array.isArray(result.info.files)) {
              urls = urls.concat(result.info.files.map(f => f.uploadInfo.secure_url));
            } else if (result.info.secure_url) {
              urls.push(result.info.secure_url);
            }
            urlField.value = urls.join(",");
          }
        }
      );
    }
  }
  // ‚¨áÔ∏è AJOUTE √áA JUSTE APR√àS LA CONFIG CLOUDINARY :
  if (window.grecaptcha && document.querySelector('#offreForm .g-recaptcha')) {
    grecaptcha.render(document.querySelector('#offreForm .g-recaptcha'));
  }
}, 400);

      document.getElementById('offreForm').onsubmit = function(ev){
        ev.preventDefault();
        if (!canSubmit("offreForm", 5, 60)) {
  showCarteNotification("‚ö†Ô∏è Trop de publications d‚Äôoffres depuis ce navigateur ! R√©essaye dans une heure.");
  return;
}
                let recaptchaResponse = grecaptcha.getResponse();
if (!recaptchaResponse) {
  showCarteNotification("‚ö†Ô∏è Merci de valider le reCAPTCHA avant d‚Äôenvoyer.");
  return;
}
        var form = ev.target;
        var now = new Date();
  var datePublication = now.toISOString().slice(0, 10);
        console.log('Formulaire location soumis');
        var data = {
          "Titre de l‚Äôoffre": form.typeOffre.value,
          "Nom de la struct": form.structure.value,
          "Adresse": form.adresse.value,
          "Latitude": form.lat.value,
          "Longitude": form.lng.value,
          "Description": form.description.value,
          "Adresse Email": form.adresseEmail.value,
         "Contact": "'" + form.contact.value,
          "Photos": form.photos.value,
          "Date de publication": datePublication,
          "Statut": "Publi√©e"
        };

     if (!(form.contact.value || form.adresseEmail.value)) {
  showCarteNotification("‚ö†Ô∏è Veuillez renseigner au moins un moyen de contact (email ou t√©l√©phone).");
  return false;
}

        fetch(API_OFFRES, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        })
        .then(response => {
          if (response.ok) {
  let gallery = "";
  if (form.photos.value) {
    let urls = form.photos.value.split(",");
    gallery = '<div class="photo-gallery">' +
      urls.map(u => u.trim() ? '<img src="'+u.trim()+'" alt="photo" onclick="window.showLightbox(\''+u.trim()+'\')">' : "").join("") +
      '</div>';
  }
  L.marker([form.lat.value, form.lng.value])
    .addTo(map)
    .bindPopup(
      `<b>${form.typeOffre.value}</b><br>
      ${form.structure.value}<br>
      ${form.adresse.value}<br>
      ${form.description.value}<br>
      ${gallery}
      <b>Contact :</b> ${form.contact.value}<br>
      ${form.adresseEmail.value ? `<b>Email :</b> ${form.adresseEmail.value}<br>` : ""}
      <button type="button" class="btn-postuler" data-email="${form.adresseEmail.value}" data-contact="${form.contact.value}">Postuler √† cette offre</button>
      `
    );
  grecaptcha.reset();
  map.closePopup();
  showCarteNotification("‚úÖ Offre ajout√©e !");
} else {
  showCarteNotification("‚ùå Erreur lors de l'ajout de l'offre");
}
        });
      };
    } 
function afficherFormulaireLocation(latlng) {
  var popupContent = `
    <form id="locationForm">
      <b>Mettre un cabinet ou bureau en location</b><br>
      Adresse :<br>
      <input type="text" name="adresse" required><br>
      Latitude :<br>
      <input type="text" name="lat" value="${latlng.lat}" readonly><br>
      Longitude :<br>
      <input type="text" name="lng" value="${latlng.lng}" readonly><br>
      Description :<br>
      <textarea name="description" required></textarea><br>
      Email :<br>
<input type="email" name="email"><br>
Contact (t√©l√©phone) :<br>
      <input type="text" name="contact"><br>
      Photos :<br>
      <input type="text" id="locationPhotoURL" name="photos" placeholder="Lien(s) photo..." readonly style="width:70%;"> 
      <button type="button" id="cloudinaryBtnLocation">Uploader des photos</button><br>
       <div class="g-recaptcha" data-sitekey="6LcL9ZYrAAAAACVHhVg6o6Xyj0_y2uR5X0n-URGb"></div>
      <button type="submit" style="margin-top:8px;">Publier l'annonce</button>
    </form>
  `;
  var popup = L.popup()
    .setLatLng(latlng)
    .setContent(popupContent)
    .openOn(map);

  // Gestion Cloudinary pour photos
 setTimeout(function() {
  var cloudName = 'damdqxu7t';
  var uploadBtn = document.getElementById('cloudinaryBtnLocation');
  var urlField = document.getElementById('locationPhotoURL');
  if (uploadBtn) {
    uploadBtn.onclick = function() {
      cloudinary.openUploadWidget(
        {
          cloudName: cloudName,
          uploadPreset: 'fwmed_unsigned',
          sources: ['local', 'url', 'camera'],
          multiple: true,
          folder: 'locations-farwestmed',
          cropping: false,
          resourceType: 'image',
          maxFileSize: 10485760 // 10MB
        },
        function(error, result) {
          if (!error && result && result.event === "success") {
            let urls = urlField.value ? urlField.value.split(",") : [];
            if (result.info.files && Array.isArray(result.info.files)) {
              urls = urls.concat(result.info.files.map(f => f.uploadInfo.secure_url));
            } else if (result.info.secure_url) {
              urls.push(result.info.secure_url);
            }
            urlField.value = urls.join(",");
          }
        }
      );
    }
  }

  // <-- C'est ici, √† l'int√©rieur du setTimeout !
  if (window.grecaptcha && document.querySelector('#locationForm .g-recaptcha')) {
    grecaptcha.render(document.querySelector('#locationForm .g-recaptcha'));
  }
}, 200);
  // Soumission du formulaire location
document.getElementById('locationForm').onsubmit = function(ev){
  ev.preventDefault();
  if (!canSubmit("locationForm", 5, 60)) {
    showCarteNotification("‚ö†Ô∏è Trop de demandes pour ce poste depuis ce navigateur ! R√©essaye dans une heure.");
    return;
     }
  let recaptchaResponse = grecaptcha.getResponse();
if (!recaptchaResponse) {
  showCarteNotification("‚ö†Ô∏è Merci de valider le reCAPTCHA avant d‚Äôenvoyer.");
  return;
}
  var form = ev.target;
  var now = new Date();
  var datePublication = now.toISOString().slice(0, 10);

  var data = {
    Title: "Location via carte", // Tu peux aussi rajouter un champ input pour le titre !
    Adresse: form.adresse.value,
    Latitude: parseFloat(form.lat.value),
    Longitude: parseFloat(form.lng.value),
    Description: form.description.value,
    Email: form.email.value,
    Contact: form.contact.value,
    Photos: form.photos.value,
    Statut: "Publi√©e",
    "Date de publication": datePublication
  };

  fetch(API_LOCATIONS, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "xc-token": API_TOKEN
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(resp => {
    showCarteNotification("‚úÖ Annonce de location ajout√©e !");
    // Ajoute le marker sur la carte si tu veux un retour instantan√©¬†:
    var locationIcon = L.divIcon({
      html: `<div style="
        font-size:2em;
        width:40px;height:40px;
        border-radius:50%;
        background:#fffbe7;
        border:2px solid #ffe49c;
        display:flex;
        align-items:center;
        justify-content:center;
        box-shadow:0 1px 5px #ffd70077;
      ">üè¢</div>`,
      className: '',
      iconSize: [40, 40],
      iconAnchor: [20, 40],
      popupAnchor: [0, -40]
    });
    L.marker([parseFloat(form.lat.value), parseFloat(form.lng.value)], {icon: locationIcon})
      .addTo(map)
      .bindPopup(
        `<b>Cabinet ou bureau √† louer</b><br>
        ${form.adresse.value}<br>
        ${form.description.value}<br>
        <b>Contact :</b> ${form.contact.value}<br>
        ${form.email.value ? `<b>Email :</b> ${form.email.value}<br>` : ""}`
      );
    map.closePopup();
  })
  .catch(err => {
    showCarteNotification("‚ùå Erreur r√©seau : " + err);
    console.error("Erreur r√©seau : ", err);
  });
};
}
map.on('click', function(e) {
  var latlng = e.latlng;
  var popupContent = `
    <b>Que souhaitez-vous faire&nbsp;?</b><br><br>
    <button id="btnDeposerOffre" style="background:#f9d875;color:#4b3c10;padding:8px 18px;font-size:1em;border-radius:8px;border:none;cursor:pointer;margin-bottom:12px;font-weight:bold;">
      D√©poser une offre d'emploi
    </button><br>
    <button id="btnProposerLocation" style="background:#fffbe7;color:#554400;padding:8px 18px;font-size:1em;border-radius:8px;border:1px solid #ffe49c;cursor:pointer;font-weight:bold;">
      Mettre un cabinet ou bureau en location
    </button>
  `;
  var popup = L.popup()
    .setLatLng(latlng)
    .setContent(popupContent)
    .openOn(map);

  // ‚¨áÔ∏è On force un d√©lai de 600ms pour √™tre certain que le DOM est pr√™t
  setTimeout(function() {
    var btnDeposer = document.getElementById('btnDeposerOffre');
    var btnLoc = document.getElementById('btnProposerLocation');
    // DEBUG
    console.log('btnDeposer:', btnDeposer, 'btnLoc:', btnLoc);

    if (btnDeposer) {
      btnDeposer.onclick = function() {
        afficherFormulaireOffre(latlng);
      };
    }
    if (btnLoc) {
      btnLoc.onclick = function() {
        afficherFormulaireLocation(latlng);
      };
    }
  }, 600);
});
   
    // PATCH ULTIME : Listener global pour bouton Envoyer (candidature)
    document.body.addEventListener('click', function(e) {
      if (e.target && e.target.id === "sendCandidature") {
           let recaptchaResponse = grecaptcha.getResponse();
   if (!recaptchaResponse) {
  showCarteNotification("‚ö†Ô∏è Merci de valider le reCAPTCHA avant d‚Äôenvoyer.");
  return;
}
if (!canSubmit("candidatureForm", 5, 60)) {
  showCarteNotification("‚ö†Ô∏è Trop de candidatures envoy√©es depuis ce navigateur ! R√©essaye dans une heure.");
  return;
}
    if (e.target.disabled) return;
    e.target.disabled = true;

        var nom = document.getElementById('candidatNom') ? document.getElementById('candidatNom').value : "";
        var emailCand = document.getElementById('candidatEmail') ? document.getElementById('candidatEmail').value : "";
        var msg = document.getElementById('candidatMsg') ? document.getElementById('candidatMsg').value : "";
        var now = new Date();
        var dateStr = now.toISOString().slice(0, 19).replace('T', ' ');

        var titre = "";
        var titreElem = document.querySelector(".leaflet-popup-content b");
        if (titreElem) titre = titreElem.textContent || "";

        var email = e.target.getAttribute("data-email") || "";
        var contact = e.target.getAttribute("data-contact") || "";

        var data = {
          "Nom offre": titre,
          "Nom du candidat": nom,
          "Email du candidat": emailCand,
          "Message": msg,
          "Email employeur": email,
          "Contact employeur": contact,
          "Date candidature": dateStr
        };

        fetch(API_CANDIDATURES, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        })
        .then(response => {
          if (response.ok) {
            alert("Votre candidature a bien √©t√© enregistr√©e !");
            var closeBtn = document.querySelector('.leaflet-popup-close-button');
            if (closeBtn) closeBtn.click();
          } else {
            alert("Erreur lors de la candidature.");
          }
          e.target.disabled = false;
        })
        .catch(function() {
          alert("Erreur lors de la candidature (r√©seau).");
          e.target.disabled = false;
        });
      }
    });
    // ----- INT√âR√äT POUR LOCATION -----
    document.body.addEventListener('click', function(e) {
  if (e.target && e.target.classList.contains('btn-interesse-location')) {
    let btn = e.target;
    let popupForm = `
      <b>Je suis int√©ress√©(e) par ce local</b><br>
      Votre nom :<br><input type="text" id="interesseNom"><br>
      Votre email :<br><input type="email" id="interesseEmail"><br>
      Message :<br><textarea id="interesseMsg"></textarea><br>
      <div class="g-recaptcha" data-sitekey="6LcL9ZYrAAAAACVHhVg6o6Xyj0_y2uR5X0n-URGb"></div>
      <button type="button" id="sendInteresseLocation"
        data-email="${btn.getAttribute('data-email') || ""}"
        data-contact="${btn.getAttribute('data-contact') || ""}"
        data-adresse="${btn.getAttribute('data-adresse') || ""}"
        data-description="${btn.getAttribute('data-description') || ""}"
        style="background:#B6E3FF;color:#095b89;padding:6px 18px;font-size:1em;border-radius:8px;border:none;cursor:pointer;margin-top:8px;">
        Envoyer ma demande
      </button>
      <button type="button" id="cancelInteresseLocation" style="margin-left:8px;">Annuler</button>
    `;
    let popupContent = btn.closest('.leaflet-popup-content');
    if (popupContent) popupContent.innerHTML = popupForm;
   setTimeout(() => {
  let btnCancel = document.getElementById('cancelInteresseLocation');
  if (btnCancel) btnCancel.onclick = function() {
    let popup = btn.closest('.leaflet-popup-content');
    if (popup) window.map.closePopup();
    grecaptcha.reset();
  };
  // ‚¨áÔ∏è AJOUTE CE BLOC¬†: 
  if (window.grecaptcha && document.querySelector('#interesseNom') && document.querySelector('.g-recaptcha')) {
    grecaptcha.render(document.querySelector('.g-recaptcha'));
  }
}, 100);
  }
});

document.body.addEventListener('click', function(e) {
  if (e.target && e.target.id === "sendInteresseLocation") {
     let recaptchaResponse = grecaptcha.getResponse();
    if (!recaptchaResponse) {
      showCarteNotification("‚ö†Ô∏è Merci de valider le reCAPTCHA avant d‚Äôenvoyer.");
      return;
    }
    if (!canSubmit("interetLocationForm", 5, 60)) {
  showCarteNotification("‚ö†Ô∏è Trop de demandes envoy√©es depuis ce navigateur ! R√©essaye dans une heure.");
  return;
}
    let nom = document.getElementById('interesseNom').value.trim();
    let email = document.getElementById('interesseEmail').value.trim();
    let msg = document.getElementById('interesseMsg').value.trim();
    let now = new Date().toISOString();
    // NOUVEAU : r√©cup√®re l‚Äôemail du proprio transmis via le bouton
    let contactProprio = e.target.getAttribute("data-email") || "";

    fetch('https://app.nocodb.com/api/v2/tables/ml293gbtbvnhsyf/records', {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "xc-token": "zuBtJi0p7vALQo2W_HTWzvaYRxyyQKOhRaLsrNU4"
      },
      body: JSON.stringify({
        "Nom": nom,
        "Email": email,
        "Message": msg,
        "Contact propri√©taire": contactProprio,  // <-- c‚Äôest ici la correction !
        "Date": now
      })
    })
    .then(r => r.json())
    .then(resp => {
      showCarteNotification("‚úÖ Votre demande a √©t√© transmise !");
      grecaptcha.reset();
      setTimeout(() => { window.map.closePopup(); }, 1200);
    })
    .catch(() => showCarteNotification("‚ùå Erreur lors de l'envoi."));
  }
});
  </script>
  <script>
function toggleSidebar() {
  var sb = document.getElementById('sidebar-mode-emploi');
  var btn = document.getElementById('sidebar-toggle-btn');
  sb.classList.toggle('open');
  sb.classList.toggle('closed');
  // Change la fl√®che
  var arrow = document.getElementById('toggle-arrow');
  if (sb.classList.contains('open')) {
    arrow.innerHTML = '&#9664;'; // fl√®che vers la gauche (fermer)
    btn.setAttribute('aria-label', "Masquer le mode d'emploi");
  } else {
    arrow.innerHTML = '&#9654;'; // fl√®che vers la droite (ouvrir)
    btn.setAttribute('aria-label', "Afficher le mode d'emploi");
  }
}
</script>
  
  <script src="https://www.google.com/recaptcha/api.js"></script>
</body>
</html>
<!-- mini commit pour forcer le d√©ploiement -->
